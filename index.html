<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leafy Library | necotastudio</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --wood-brown: #5D4037;
            --paper-white: #F5F5DC;
            --rare-c: #9e9e9e; --rare-u: #2196f3; --rare-r: #9c27b0; --rare-e: #ff9800; --rare-l: #d4af37;
        }
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--paper-white); color: var(--wood-brown); margin: 0; padding-bottom: 80px; display: flex; flex-direction: column; align-items: center; }
        header { background: var(--primary-green); color: white; width: 100%; padding: 15px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        .back-home { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: white; text-decoration: none; font-size: 0.8rem; border: 1px solid white; padding: 4px 10px; border-radius: 20px; font-weight: bold; background: rgba(0,0,0,0.1); cursor: pointer; }
        
        .container { width: 95%; max-width: 500px; margin: 10px 0; box-sizing: border-box; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .status-box { background: white; padding: 15px; border-radius: 20px; text-align: center; border: 2px solid #ddd; }
        .leaf-display { font-size: 2rem; font-weight: 900; color: var(--dark-green); margin: 5px 0; }
        .limit-bar-container { background: #eee; height: 8px; border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .limit-bar { background: var(--primary-green); height: 100%; width: 0%; transition: 0.3s; }

        /* æœ¬æ£š */
        .bookshelf { background-color: var(--wood-brown); padding: 15px; border-radius: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 5px; border-bottom: 15px solid #3e2723; box-shadow: inset 0 -5px 15px rgba(0,0,0,0.4); }
        .book-spine { width: 18px; height: 65px; border-left: 2px solid rgba(255,255,255,0.2); border-radius: 2px; cursor: pointer; transition: 0.2s; }
        .book-spine:hover { transform: translateY(-10px); }
        .glow-l { box-shadow: 0 0 12px var(--rare-l); border: 1px solid white; }

        /* å…¥åŠ› */
        .input-card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 3px solid var(--primary-green); }
        .m-btn { flex: 1; padding: 10px; border: 2px solid var(--primary-green); background: white; border-radius: 12px; cursor: pointer; font-weight: bold; font-family: inherit; }
        .m-btn.active { background: var(--primary-green); color: white; }
        .count-btn { padding: 15px 0; border-radius: 12px; border: 2px solid var(--primary-green); background: white; color: var(--dark-green); font-weight: 900; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 0 var(--primary-green); }
        .count-btn:active { transform: translateY(3px); box-shadow: none; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒ»å ±å‘Š */
        .report-box { background: #E3F2FD; padding: 15px; border-radius: 15px; text-align: center; margin-top: 20px; border: 1px dashed #2196F3; }
        .share-btn { background: #000; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 10px; }
        
        .ad-space { background: #fff; border: 1px solid #eee; padding: 20px; margin-top: 20px; border-radius: 15px; text-align: center; color: #888; font-size: 0.8rem; }
        
        .footer-links { margin-top: 30px; text-align: center; font-size: 0.8rem; }
        .footer-links a { color: var(--wood-brown); margin: 0 10px; text-decoration: none; font-weight: bold; }

        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 100; display:none; }
        #panel { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:85%; max-width:400px; background:white; border-radius:30px; padding:30px; z-index: 101; display:none; text-align:center; border: 6px solid var(--primary-green); }
    </style>
</head>
<body>

<header>
    <div class="back-home" onclick="safeGoBack()"><i class="fas fa-chevron-left"></i> æˆ»ã‚‹</div>
    <h1 style="margin:0; font-size: 1.5rem;">Leafy Library</h1>
</header>

<div class="container status-box">
    <div id="user-display" style="font-size: 12px; color: #666; margin-bottom: 5px;">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="leaf-display">ğŸƒ <span id="leaf-total">0</span> <small style="font-size: 1rem;">æš</small></div>
    <div class="limit-info" style="font-size:11px; display:flex; justify-content:space-between;">
        <span>ä»Šæ—¥ã®åè”µä¸Šé™</span>
        <span><span id="daily-count-txt">0</span> / 50 æš</span>
    </div>
    <div class="limit-bar-container"><div id="limit-bar" class="limit-bar"></div></div>
    <button id="login-btn" class="count-btn" style="width: 100%; font-size: 1rem; padding: 8px; margin-top:15px; display:none;" onclick="login()">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div class="container"><div class="bookshelf" id="my-shelf"></div></div>

<div class="container input-card">
    <div style="display:flex; gap:8px; margin-bottom:15px;">
        <button id="m-veg" class="m-btn active" onclick="switchMode('veg')">ğŸ¥¬ è‘‰ã£ã±</button>
        <button id="m-dish" class="m-btn" onclick="switchMode('dish')">ğŸ³ æ–™ç†</button>
    </div>
    <select id="cat-select" style="width:100%; padding:10px; border-radius:10px; margin-bottom:10px;" onchange="updateItemList()"></select>
    <select id="item-select" style="width:100%; padding:10px; border-radius:10px; margin-bottom:10px;"></select>
    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
        <button class="count-btn" onclick="earnLeaves(1)">+1</button>
        <button class="count-btn" onclick="earnLeaves(5)">+5</button>
        <button class="count-btn" onclick="earnLeaves(10)">+10</button>
        <button class="count-btn" style="background:#ff9800; color:white;" onclick="earnLeaves(30)">+30</button>
    </div>
    <button id="undo-btn" class="btn-undo" onclick="undoLast()" disabled style="float:right; margin-top:10px; padding:5px 15px; border-radius:15px; background:#f44336; color:white; border:none; cursor:pointer;">1ã¤æˆ»ã™</button>
</div>

<div class="container report-box">
    <div style="font-weight:bold; font-size:0.9rem;">ä»Šæ—¥ã®æ´»å‹•ã‚’å ±å‘Šã—ã‚ˆã†ï¼</div>
    <a id="x-share" href="#" target="_blank" class="share-btn"><i class="fab fa-x-twitter"></i> Xã§å ±å‘Šã™ã‚‹</a>
</div>

<div class="container ad-space">
    <i class="fas fa-shopping-basket"></i> <b>ãŠã™ã™ã‚ã®é‡èœãƒ»èª¿ç†å™¨å…·</b><br>
    <div style="margin-top:10px; font-size:0.7rem;">(ã“ã“ã«Amazonã‚„æ¥½å¤©ã®ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã‚’è²¼ã‚Œã¾ã™)</div>
</div>

<div class="container">
    <h3 style="border-left: 5px solid var(--primary-green); padding-left: 10px;">äº¤æ›æ‰€ (Store)</h3>
    <div id="store-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
</div>

<div class="footer-links">
    <a href="https://jyonjyon-code.github.io/hirumeshi/"><i class="fas fa-home"></i> ã²ã‚‹ã‚ã—ãƒ›ãƒ¼ãƒ </a>
    <a href="https://www.instagram.com/necotastudio" target="_blank"><i class="fab fa-instagram"></i> necotastudio</a>
    <p style="color:#aaa; font-size:10px; margin-top:15px;">&copy; 2026 necotastudio</p>
</div>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div id="panel"><div id="panel-content"></div><button class="m-btn" style="margin-top:20px;" onclick="closePanel()">é–‰ã˜ã‚‹</button></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyA7pcr0G4qEx0yLNWueZPdaeQoEBjFuoic", authDomain: "necotastudio-app.firebaseapp.com", projectId: "necotastudio-app", storageBucket: "necotastudio-app.firebasestorage.app", messagingSenderId: "1093173509944", appId: "1:1093173509944:web:5340935ddffdd49628cbcd" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ãƒ‡ãƒ¼ã‚¿è¨­å®š
    const vData = { "å®šç•ª": ["ã‚­ãƒ£ãƒ™ãƒ„", "ãƒ¬ã‚¿ã‚¹", "ç™½èœ", "ã»ã†ã‚Œã‚“è‰"], "é¦™å‘³": ["å¤§è‘‰", "èŒ—è·", "ãƒ‹ãƒ©"], "ã‚µãƒ©ãƒ€": ["ãƒ‘ã‚¯ãƒãƒ¼", "ã‚±ãƒ¼ãƒ«"] };
    const dData = { "æ–™ç†": ["ã‚µãƒ©ãƒ€", "é‡èœç‚’ã‚", "é’æ±", "ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼"] };
    const rarities = { C: { color: "#9e9e9e", price: 20 }, U: { color: "#2196f3", price: 100 }, R: { color: "#9c27b0", price: 300 }, E: { color: "#ff9800", price: 800 }, L: { color: "#d4af37", price: 2500 } };
    const bookMaster = [
        { id:1, title:"ã‚­ãƒ£ãƒ™ãƒ„ç‹æœã®è¨˜éŒ²", rare:"C", desc:"ç·‘ã®å¸å›½ã®æ­´å²ã€‚" },
        { id:2, title:"å…‰åˆæˆã®ãƒ‘ãƒ«ã‚¹", rare:"U", desc:"å…‰ã‚’åŠ›ã«å¤‰ãˆã‚‹ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã€‚" },
        { id:5, title:"ç¿¡ç¿ ã®å¸æ›¸", rare:"L", desc:"necotastudioæãä¸‹ã‚ã—ä½œå“ã€‚" }
    ];

    let myLeaves = 0, myBooks = [], dailyCount = 0, lastAdd = 0, todayStr = new Date().toLocaleDateString();

    window.login = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('user-display').innerText = `ğŸŒ¿ ${user.displayName} ã•ã‚“`;
            await loadData(user.uid);
        } else {
            document.getElementById('login-btn').style.display = 'block';
            document.getElementById('user-display').innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„";
        }
    });

    async function loadData(uid) {
        const docSnap = await getDoc(doc(db, "leafy_library", uid));
        if (docSnap.exists()) {
            const d = docSnap.data();
            myLeaves = d.leaves || 0; myBooks = d.books || [];
            dailyCount = (d.lastDate === todayStr) ? (d.dailyCount || 0) : 0;
        }
        updateUI();
    }

    async function sync() {
        const user = auth.currentUser;
        if (user) {
            await setDoc(doc(db, "leafy_library", user.uid), { leaves: myLeaves, books: myBooks, dailyCount: dailyCount, lastDate: todayStr }, { merge: true });
        }
        updateXLink();
    }

    window.earnLeaves = async (val) => {
        if (dailyCount + val > 50) { alert("1æ—¥ã®ä¸Šé™ã¯50æšã§ã™ã€‚"); return; }
        myLeaves += val; dailyCount += val; lastAdd = val;
        document.getElementById('undo-btn').disabled = false;
        updateUI(); await sync();
    };

    window.undoLast = async () => {
        if (lastAdd > 0) {
            myLeaves -= lastAdd; dailyCount -= lastAdd; lastAdd = 0;
            document.getElementById('undo-btn').disabled = true;
            updateUI(); await sync();
        }
    };

    function updateUI() {
        document.getElementById('leaf-total').innerText = myLeaves;
        document.getElementById('daily-count-txt').innerText = dailyCount;
        document.getElementById('limit-bar').style.width = `${(dailyCount/50)*100}%`;
        renderShelf(); renderStore(); updateXLink();
    }

    function updateXLink() {
        const text = encodeURIComponent(`Leafy Libraryã§ä»Šæ—¥ ${dailyCount}æš ã®è‘‰ã£ã±ã‚’é›†ã‚ã¾ã—ãŸï¼ç¾åœ¨ã®æ‰€è”µæ•°ã¯ ${myBooks.length}å†Š ã§ã™ğŸŒ¿ #LeafyLibrary #necotastudio`);
        document.getElementById('x-share').href = `https://twitter.com/intent/tweet?text=${text}`;
    }

    window.safeGoBack = async () => {
        const user = auth.currentUser;
        if (user) await sync();
        window.location.href = "https://jyonjyon-code.github.io/hirumeshi/";
    };

    window.switchMode = (m) => {
        document.getElementById('m-veg').className = m==='veg' ? 'm-btn active' : 'm-btn';
        document.getElementById('m-dish').className = m==='dish' ? 'm-btn active' : 'm-btn';
        const catS = document.getElementById('cat-select'); catS.innerHTML = "";
        const target = m==='veg' ? vData : dData;
        Object.keys(target).forEach(c => catS.add(new Option(c, c)));
        updateItemList();
    };

    window.updateItemList = () => {
        const cat = document.getElementById('cat-select').value;
        const itemS = document.getElementById('item-select'); itemS.innerHTML = "";
        const target = (vData[cat] || dData[cat]);
        target.forEach(i => itemS.add(new Option(i, i)));
    };

    function renderShelf() {
        const shelf = document.getElementById('my-shelf'); shelf.innerHTML = "";
        myBooks.forEach(bid => {
            const b = bookMaster.find(x => x.id === bid);
            if (!b) return;
            const spine = document.createElement('div');
            spine.className = `book-spine ${b.rare==='L' ? 'glow-l' : ''}`;
            spine.style.backgroundColor = rarities[b.rare].color;
            spine.onclick = () => showPanel(`<h2>ã€${b.title}ã€</h2><p>${b.desc}</p>`);
            shelf.appendChild(spine);
        });
    }

    function renderStore() {
        const grid = document.getElementById('store-grid'); grid.innerHTML = "";
        bookMaster.forEach(b => {
            const r = rarities[b.rare];
            const isBought = myBooks.includes(b.id);
            const canBuy = myLeaves >= r.price;
            grid.innerHTML += `<div style="background:white; padding:10px; border-radius:15px; border:2px solid ${r.color}; text-align:center;">
                <span style="font-size:10px; background:${r.color}; color:white; padding:2px 5px; border-radius:5px;">${b.rare}</span><br>
                <b style="font-size:0.8rem;">${b.title}</b><br>
                <span style="color:red; font-weight:bold;">${r.price}æš</span><br>
                <button onclick="buyBook(${b.id})" style="width:100%; border:none; border-radius:5px; padding:5px; margin-top:5px; background:${canBuy?r.color:'#ccc'}; color:white;" ${isBought||!canBuy?'disabled':''}>${isBought?'æ‰€è”µæ¸ˆ':'è³¼å…¥'}</button>
            </div>`;
        });
    }

    window.buyBook = async (id) => {
        const b = bookMaster.find(x => x.id === id);
        if(myLeaves >= rarities[b.rare].price) {
            myLeaves -= rarities[b.rare].price; myBooks.push(id);
            updateUI(); await sync();
        }
    };

    window.showPanel = (html) => { document.getElementById('panel-content').innerHTML = html; document.getElementById('panel').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; };
    window.closePanel = () => { document.getElementById('panel').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };

    switchMode('veg');
</script>
</body>
</html>
