<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leafy Library | necotastudio</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --wood-brown: #5D4037;
            --paper-white: #F5F5DC;
            --rare-c: #9e9e9e; --rare-u: #2196f3; --rare-r: #9c27b0; --rare-e: #ff9800; --rare-l: #d4af37;
        }
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--paper-white); color: var(--wood-brown); margin: 0; padding-bottom: 40px; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        header { background: var(--primary-green); color: white; width: 100%; padding: 15px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .back-home { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: white; text-decoration: none; font-size: 0.8rem; border: 1px solid white; padding: 4px 10px; border-radius: 20px; font-weight: bold; background: rgba(0,0,0,0.1); cursor: pointer; }
        
        .container { width: 95%; max-width: 500px; margin: 10px 0; box-sizing: border-box; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ & ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
        .status-box { background: white; padding: 20px; border-radius: 25px; text-align: center; border: 2px solid #ddd; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .leaf-display { font-size: 2.5rem; font-weight: 900; color: var(--dark-green); margin: 10px 0; }
        
        .counter-ui { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0; }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: white; color: var(--primary-green); font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 0 #ccc; border: 2px solid #eee; transition: 0.1s; }
        .ctrl-btn:active { transform: translateY(3px); box-shadow: none; }
        .ctrl-btn.plus { background: var(--primary-green); color: white; box-shadow: 0 4px 0 var(--dark-green); border: none; }

        /* å›³æ›¸é¤¨ã¸ã®ãƒœã‚¿ãƒ³ */
        .go-library { width: 100%; padding: 15px; background: var(--wood-brown); color: white; border-radius: 15px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* å›³æ›¸é¤¨ãƒšãƒ¼ã‚¸ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ */
        #library-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #3e2723; z-index: 1000; display: none; flex-direction: column; overflow-y: auto; }
        .library-header { background: #2d1b18; color: #d7ccc8; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 11; display: flex; justify-content: space-between; align-items: center; }
        .shelf-container { padding: 20px; display: flex; flex-direction: column; gap: 30px; align-items: center; }
        .shelf-row { background: #5d4037; width: 100%; max-width: 600px; padding: 15px 10px 5px; border-radius: 4px; border-bottom: 12px solid #2d1b18; display: flex; flex-wrap: wrap; gap: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        .book-spine { width: 22px; height: 80px; border-radius: 2px; cursor: pointer; transition: 0.2s; position: relative; border-left: 3px solid rgba(255,255,255,0.2); }
        .book-spine:hover { transform: translateY(-15px) rotate(-2deg); }
        .glow-l { box-shadow: 0 0 15px var(--rare-l); border: 1px solid gold; }

        /* å…±é€š UI */
        .input-card { background: white; padding: 20px; border-radius: 25px; border: 3px solid var(--primary-green); }
        .m-btn { flex: 1; padding: 10px; border: 2px solid var(--primary-green); background: white; border-radius: 12px; cursor: pointer; font-weight: bold; font-family: inherit; }
        .m-btn.active { background: var(--primary-green); color: white; }
        
        /* ãƒ‘ãƒãƒ« */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 2000; display:none; }
        #panel { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:85%; max-width:400px; background:white; border-radius:30px; padding:30px; z-index: 2001; display:none; text-align:center; border: 6px solid var(--primary-green); }
    </style>
</head>
<body>

<header>
    <div class="back-home" onclick="safeGoBack()"><i class="fas fa-chevron-left"></i> æˆ»ã‚‹</div>
    <h1 style="margin:0; font-size: 1.2rem;">Leafy Library</h1>
</header>

<div class="container status-box">
    <div id="user-display" style="font-size: 12px; color: #666; margin-bottom: 5px;">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="leaf-display">ğŸƒ <span id="leaf-total">0</span> <small style="font-size: 1rem;">æš</small></div>
    
    <div class="counter-ui">
        <button class="ctrl-btn" onclick="adjustLeaves(-1)"><i class="fas fa-minus"></i></button>
        <div style="text-align: center;">
            <div style="font-size: 0.7rem; color: #999; margin-bottom: 5px;">ä»Šæ—¥é›†ã‚ãŸåˆ†</div>
            <div id="daily-count-txt" style="font-size: 1.5rem; font-weight: 900;">0</div>
            <div style="font-size: 0.6rem; color: #bbb;">ä¸Šé™ 50æš</div>
        </div>
        <button class="ctrl-btn plus" onclick="adjustLeaves(1)"><i class="fas fa-plus"></i></button>
    </div>

    <button class="go-library" onclick="openLibrary()">
        <i class="fas fa-book"></i> å›³æ›¸å®¤ã¸è¡Œã
    </button>
    <button id="login-btn" class="m-btn" style="width: 100%; margin-top:15px; display:none;" onclick="login()">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div class="container input-card">
    <div style="display:flex; gap:8px; margin-bottom:15px;">
        <button id="m-veg" class="m-btn active" onclick="switchMode('veg')">ğŸ¥¬ ç¨®é¡ã‹ã‚‰é¸ã¶</button>
        <button id="m-dish" class="m-btn" onclick="switchMode('dish')">ğŸ³ æ–™ç†ã‹ã‚‰é¸ã¶</button>
    </div>
    <select id="cat-select" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd;" onchange="updateItemList()"></select>
    <select id="item-select" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd;"></select>
    <p style="font-size: 0.7rem; color: #888; text-align: center; margin: 0;">â€»é¸ã‚“ã§ä¸Šã®ï¼‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­</p>
</div>

<div class="container">
    <h3 style="border-left: 5px solid var(--primary-green); padding-left: 10px;">äº¤æ›æ‰€ (Store)</h3>
    <div id="store-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
</div>

<div class="footer-links" style="text-align: center; margin-top: 20px; font-size: 0.8rem;">
    <a href="https://jyonjyon-code.github.io/hirumeshi/" style="text-decoration:none; color:var(--wood-brown); font-weight:bold;">ã²ã‚‹ã‚ã—ãƒ›ãƒ¼ãƒ </a>
    <p style="color:#aaa; font-size:10px;">&copy; 2026 necotastudio</p>
</div>

<div id="library-page">
    <div class="library-header">
        <button onclick="closeLibrary()" style="background:none; border:1px solid #d7ccc8; color:#d7ccc8; padding:5px 15px; border-radius:20px;">é–‰ã˜ã‚‹</button>
        <span style="font-weight:bold; font-size:1.2rem; font-family: serif;">Leafy Library</span>
        <span>æ‰€è”µ: <span id="lib-book-count">0</span>å†Š</span>
    </div>
    <div class="shelf-container" id="shelf-rows-container">
        </div>
</div>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div id="panel"><div id="panel-content"></div><button class="m-btn" style="margin-top:20px;" onclick="closePanel()">é–‰ã˜ã‚‹</button></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyA7pcr0G4qEx0yLNWueZPdaeQoEBjFuoic", authDomain: "necotastudio-app.firebaseapp.com", projectId: "necotastudio-app", storageBucket: "necotastudio-app.firebasestorage.app", messagingSenderId: "1093173509944", appId: "1:1093173509944:web:5340935ddffdd49628cbcd" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const vData = { "å®šç•ªè‘‰ç‰©": ["ã‚­ãƒ£ãƒ™ãƒ„", "ãƒ¬ã‚¿ã‚¹", "ç™½èœ", "ã»ã†ã‚Œã‚“è‰", "å°æ¾èœ"], "é¦™å‘³ãƒãƒ¼ãƒ–": ["å¤§è‘‰", "èŒ—è·", "ãƒ‹ãƒ©", "ãƒ‘ã‚¯ãƒãƒ¼", "ãƒã‚¸ãƒ«"], "ã‚µãƒ©ãƒ€è‘‰": ["ã‚±ãƒ¼ãƒ«", "æ°´èœ", "ãƒ™ãƒ“ãƒ¼ãƒªãƒ¼ãƒ•", "ãƒˆãƒ¬ãƒ“ã‚¹"], "ãã®ä»–": ["æ˜æ—¥è‘‰", "ãƒ¢ãƒ­ãƒ˜ã‚¤ãƒ¤", "è±†è‹—", "æ˜¥èŠ"] };
    const dData = { "å’Œé¢¨": ["ãŠæµ¸ã—", "èƒ¡éº»å’Œãˆ", "æµ…æ¼¬ã‘", "å¤©ã·ã‚‰"], "æ´‹é¢¨": ["ã‚µãƒ©ãƒ€", "ãƒ­ãƒ¼ãƒ«ã‚­ãƒ£ãƒ™ãƒ„", "ãƒã‚¸ãƒ«ãƒ‘ã‚¹ã‚¿"], "ãã®ä»–": ["é’æ±", "ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼", "ã‚¹ãƒ¼ãƒ—"] };
    const rarities = { C: { color: "#9e9e9e", price: 20 }, U: { color: "#2196f3", price: 100 }, R: { color: "#9c27b0", price: 300 }, E: { color: "#ff9800", price: 800 }, L: { color: "#d4af37", price: 2500 } };
    
    const bookMaster = [
        { id: 1, title: "ã‚­ãƒ£ãƒ™ãƒ„ã¨é¬¼é€€æ²»ã®æ—…", rare: "C", desc: "ã‚­ãƒ£ãƒ™ãƒ„ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸå°‘å¹´ãŒæ—…ã‚’ã™ã‚‹ä¸æ€è­°ãªç‰©èªã€‚" },
        { id: 2, title: "æ£®ã®é­”æ³•ä½¿ã„ã¨ç·‘ã®æ–", rare: "U", desc: "è‘‰ã£ã±ã‚’æ“ã‚‹é­”æ³•ã§ãƒ”ãƒ³ãƒã‚’åˆ‡ã‚ŠæŠœã‘ã‚‹å†’é™ºè­šã€‚" },
        { id: 3, title: "è¿·å®®ã®ãƒ¬ã‚¿ã‚¹å§«", rare: "R", desc: "ãƒ¬ã‚¿ã‚¹ã‚’è‚²ã¦ã¦ç”Ÿãå»¶ã³ã‚‹ã€ãŸãã¾ã—ã„å§«ã®ç‰©èªã€‚" },
        { id: 4, title: "éŠ€æ²³ã¸é£›ã¶ãƒãƒ¼ãƒ–èˆ¹", rare: "E", desc: "é¦™ã‚Šã®åŠ›ã§æ˜Ÿã€…ã‚’æ•‘ã†SFãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã€‚" },
        { id: 5, title: "ç¿¡ç¿ ã®å¸æ›¸ã¨ç¦æ–­ã®è‘‰", rare: "L", desc: "necotastudioæãä¸‹ã‚ã—ã€‚ç·‘ã®çŸ¥è­˜ã‚’å¸ã‚‹ç²¾éœŠã®ç‰©èªã€‚" }
    ];

    let myLeaves = 0, myBooks = [], dailyCount = 0, todayStr = new Date().toLocaleDateString();

    window.login = () => signInWithPopup(auth, provider);
    
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('user-display').innerText = `ğŸŒ¿ ${user.displayName} ã•ã‚“`;
            await loadData(user.uid);
        } else {
            document.getElementById('login-btn').style.display = 'block';
            document.getElementById('user-display').innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„";
        }
    });

    async function loadData(uid) {
        const docSnap = await getDoc(doc(db, "leafy_library", uid));
        if (docSnap.exists()) {
            const d = docSnap.data();
            myLeaves = d.leaves || 0; 
            myBooks = d.books || [];
            dailyCount = (d.lastDate === todayStr) ? (d.dailyCount || 0) : 0;
        }
        updateUI();
    }

    async function sync() {
        const user = auth.currentUser;
        if (!user) return;
        await setDoc(doc(db, "leafy_library", user.uid), { 
            leaves: myLeaves, books: myBooks, dailyCount: dailyCount, lastDate: todayStr 
        }, { merge: true });
    }

    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ“ä½œ
    window.adjustLeaves = async (val) => {
        if (val > 0 && dailyCount >= 50) { alert("1æ—¥ã®ä¸Šé™ã¯50æšã§ã™ğŸŒ¿"); return; }
        if (val < 0 && dailyCount <= 0) return;
        
        myLeaves += val;
        dailyCount += val;
        updateUI();
        await sync();
    };

    window.buyBook = async (id) => {
        const b = bookMaster.find(x => x.id === id);
        if(myLeaves >= rarities[b.rare].price) {
            myLeaves -= rarities[b.rare].price; 
            myBooks.push(id);
            updateUI(); 
            await sync();
        }
    };

    function updateUI() {
        document.getElementById('leaf-total').innerText = myLeaves;
        document.getElementById('daily-count-txt').innerText = dailyCount;
        document.getElementById('lib-book-count').innerText = myBooks.length;
        renderStore();
    }

    window.openLibrary = () => {
        renderLibrary();
        document.getElementById('library-page').style.display = 'flex';
    };
    window.closeLibrary = () => {
        document.getElementById('library-page').style.display = 'none';
    };

    function renderLibrary() {
        const container = document.getElementById('shelf-rows-container');
        container.innerHTML = "";
        
        let row = document.createElement('div');
        row.className = 'shelf-row';
        
        myBooks.forEach((bid, index) => {
            if (index > 0 && index % 15 === 0) { // 15å†Šã”ã¨ã«æ®µã‚’å¤‰ãˆã‚‹
                container.appendChild(row);
                row = document.createElement('div');
                row.className = 'shelf-row';
            }
            const b = bookMaster.find(x => x.id === bid);
            if (!b) return;
            const spine = document.createElement('div');
            spine.className = `book-spine ${b.rare==='L' ? 'glow-l' : ''}`;
            spine.style.backgroundColor = rarities[b.rare].color;
            spine.onclick = () => showPanel(b.id);
            row.appendChild(spine);
        });
        container.appendChild(row);
    }

    function renderStore() {
        const grid = document.getElementById('store-grid'); grid.innerHTML = "";
        bookMaster.forEach(b => {
            const r = rarities[b.rare];
            const isBought = myBooks.includes(b.id);
            const canBuy = myLeaves >= r.price;
            grid.innerHTML += `<div style="background:white; padding:10px; border-radius:15px; border:2px solid ${r.color}; text-align:center;">
                <span style="font-size:10px; background:${r.color}; color:white; padding:2px 5px; border-radius:5px;">${b.rare}</span><br>
                <b style="font-size:0.8rem;">${b.title}</b><br>
                <span style="color:red; font-weight:bold;">${r.price}æš</span><br>
                <button onclick="buyBook(${b.id})" style="width:100%; border:none; border-radius:5px; padding:8px; margin-top:5px; background:${canBuy?r.color:'#ccc'}; color:white;" ${isBought||!canBuy?'disabled':''}>${isBought?'æ‰€è”µæ¸ˆ':'è³¼å…¥'}</button>
            </div>`;
        });
    }

    window.showPanel = (bid) => {
        const b = bookMaster.find(x => x.id === bid);
        if (!b) return;
        const html = `
            <div style="text-align:center;">
                <span style="background:${rarities[b.rare].color}; color:white; padding:2px 10px; border-radius:10px; font-size:0.7rem;">${b.rare}</span>
                <h2 style="margin:10px 0; color:var(--dark-green);">ã€${b.title}ã€</h2>
                <div style="background:#fdfdfd; padding:15px; border-radius:15px; border:1px solid #eee; text-align:left; font-size:0.9rem; line-height:1.6; margin-bottom:15px;">${b.desc}</div>
                <a href="https://www.rakuten.co.jp/" target="_blank" style="text-decoration:none;">
                    <button style="background:#bf0000; color:white; border:none; padding:10px 20px; border-radius:10px; font-weight:bold; cursor:pointer; width:100%; font-size:1rem;"><i class="fas fa-shopping-cart"></i> æ¥½å¤©ã§æ¢ã™</button>
                </a>
            </div>`;
        document.getElementById('panel-content').innerHTML = html;
        document.getElementById('panel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    };

    window.switchMode = (m) => {
        document.getElementById('m-veg').className = m==='veg' ? 'm-btn active' : 'm-btn';
        document.getElementById('m-dish').className = m==='dish' ? 'm-btn active' : 'm-btn';
        const catS = document.getElementById('cat-select'); catS.innerHTML = "";
        const target = m==='veg' ? vData : dData;
        Object.keys(target).forEach(c => catS.add(new Option(c, c)));
        updateItemList();
    };

    window.updateItemList = () => {
        const cat = document.getElementById('cat-select').value;
        const itemS = document.getElementById('item-select'); itemS.innerHTML = "";
        const target = (vData[cat] || dData[cat]);
        target.forEach(i => itemS.add(new Option(i, i)));
    };

    window.safeGoBack = async () => {
        const user = auth.currentUser;
        if (user) await sync();
        window.location.href = "https://jyonjyon-code.github.io/hirumeshi/";
    };

    window.closePanel = () => { document.getElementById('panel').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };

    switchMode('veg');
</script>
</body>
</html>
