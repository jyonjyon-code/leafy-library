<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leafy Library | necotastudio</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --wood-brown: #5D4037;
            --paper-white: #F5F5DC;
            --rare-c: #9e9e9e; --rare-u: #2196f3; --rare-r: #9c27b0; --rare-e: #ff9800; --rare-l: #d4af37;
        }
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--paper-white); color: var(--wood-brown); margin: 0; padding-bottom: 80px; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        header { background: var(--primary-green); color: white; width: 100%; padding: 15px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        
        .back-home { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: white; text-decoration: none; font-size: 0.8rem; border: 1px solid white; padding: 6px 12px; border-radius: 20px; font-weight: bold; background: rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        .container { width: 95%; max-width: 500px; margin: 10px 0; box-sizing: border-box; }
        .status-box { background: white; padding: 20px; border-radius: 25px; text-align: center; border: 2px solid #ddd; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .leaf-display { font-size: 2.5rem; font-weight: 900; color: var(--dark-green); margin: 10px 0; }
        
        .action-btns { display: flex; gap: 10px; margin-top: 10px; }
        .go-library { flex: 2; padding: 15px; background: var(--wood-brown); color: white; border-radius: 15px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .share-x { flex: 1; padding: 15px; background: #000; color: white; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .login-btn-style { background: #4285F4; color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        .log-container { background: white; border-radius: 20px; border: 1px solid #ddd; padding: 10px; margin-top: 15px; max-height: 200px; overflow-y: auto; text-align: left; }
        .log-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #f9f9f9; font-size: 0.9rem; }
        .log-delete { color: #ff5252; cursor: pointer; padding: 5px; font-size: 1.1rem; }

        .input-card { background: white; padding: 20px; border-radius: 25px; border: 3px solid var(--primary-green); position: relative; }
        .m-btn { flex: 1; padding: 10px; border: 2px solid var(--primary-green); background: white; border-radius: 12px; cursor: pointer; font-weight: bold; font-family: inherit; }
        .m-btn.active { background: var(--primary-green); color: white; }
        
        .info-tip { font-size: 0.7rem; color: var(--primary-green); text-align: right; margin-top: -10px; margin-bottom: 5px; cursor: pointer; text-decoration: underline; }

        footer { margin-top: 30px; padding: 20px; text-align: center; width: 100%; border-top: 1px solid #ddd; background: #fff; }
        .footer-home-btn { background: var(--wood-brown); color: white; border: none; padding: 10px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; margin-bottom: 10px; font-size: 0.9rem; }
        .copyright { font-size: 0.8rem; color: #999; }

        #library-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #3e2723; z-index: 1000; display: none; flex-direction: column; overflow-y: auto; }
        .library-header { background: #2d1b18; color: #d7ccc8; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 11; display: flex; justify-content: space-between; align-items: center; }
        .shelf-container { padding: 20px; display: flex; flex-direction: column; gap: 30px; align-items: center; }
        .shelf-row { background: #5d4037; width: 100%; max-width: 600px; padding: 15px 10px 5px; border-radius: 4px; border-bottom: 12px solid #2d1b18; display: flex; flex-wrap: wrap; gap: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); box-sizing: border-box; }
        .book-spine { width: 22px; height: 80px; border-radius: 2px; cursor: pointer; transition: 0.2s; border-left: 3px solid rgba(255,255,255,0.2); }
        .book-spine:hover { transform: translateY(-15px); }

        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 2000; display:none; }
        #panel { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:85%; max-width:400px; background:white; border-radius:30px; padding:30px; z-index: 2001; display:none; text-align:center; border: 6px solid var(--primary-green); }
        .rakuten-btn { background: #bf0000; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 15px; font-size: 1rem; }
    </style>
</head>
<body>

<header>
    <div class="back-home" onclick="safeGoBack(event)"><i class="fas fa-home"></i> ãƒ›ãƒ¼ãƒ </div>
    <h1 style="margin:0; font-size: 1.2rem;">Leafy Library</h1>
</header>

<div class="container status-box">
    <div id="user-display" style="font-size: 14px; font-weight: bold; color: #444; margin-bottom: 8px;">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="leaf-display">ğŸƒ <span id="leaf-total">0</span> <small style="font-size: 1rem;">æš</small></div>
    
    <div id="logged-in-actions" style="display:none;">
        <div class="action-btns">
            <button class="go-library" onclick="openLibrary()"><i class="fas fa-book"></i> å›³æ›¸å®¤</button>
            <button class="share-x" onclick="shareOnX()"><i class="fab fa-x-twitter"></i> å ±å‘Š</button>
        </div>
    </div>
    <button id="login-btn" class="login-btn-style" style="display:none;" onclick="login()"><i class="fab fa-google"></i> Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div class="container input-card">
    <div style="display:flex; gap:8px; margin-bottom:15px;">
        <button id="m-veg" class="m-btn active" onclick="switchMode('veg')">ğŸ¥¬ ç¨®é¡</button>
        <button id="m-dish" class="m-btn" onclick="switchMode('dish')">ğŸ³ æ–™ç†</button>
    </div>
    <div id="shopping-hint" class="info-tip" onclick="openShopping()">ğŸ›’ ã“ã®é£Ÿæãƒ»æ–™ç†ã‚’æ¢ã™</div>
    <select id="cat-select" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd;" onchange="updateItemList()"></select>
    <select id="item-select" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd;"></select>
    
    <div style="display: flex; align-items: center; justify-content: space-between; background: #f0f0f0; padding: 10px 20px; border-radius: 15px;">
        <div style="text-align: left;">
            <div style="font-size: 0.7rem; color: #999;">ä»Šæ—¥é›†ã‚ãŸåˆ†</div>
            <div id="daily-count-txt" style="font-size: 1.5rem; font-weight: 900;">0</div>
        </div>
        <button onclick="addEntry()" style="background: var(--primary-green); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer;">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <div id="log-list" class="log-container">
        <p style="font-size: 0.7rem; color: #ccc; text-align: center;">ä»Šæ—¥ã®ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    </div>
</div>

<div class="container">
    <h3 style="border-left: 5px solid var(--primary-green); padding-left: 10px;">äº¤æ›æ‰€ (Store)</h3>
    <div id="store-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
</div>

<footer>
    <button class="footer-home-btn" onclick="safeGoBack(event)"><i class="fas fa-home"></i> ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
    <div class="copyright">Â© necotastudio</div>
</footer>

<div id="library-page">
    <div class="library-header">
        <button onclick="closeLibrary()" style="background:none; border:1px solid #d7ccc8; color:#d7ccc8; padding:5px 15px; border-radius:20px;">é–‰ã˜ã‚‹</button>
        <span style="font-weight:bold; font-size:1.2rem; font-family: serif;">Leafy Library</span>
        <span>æ‰€è”µ: <span id="lib-book-count">0</span>å†Š</span>
    </div>
    <div class="shelf-container" id="shelf-rows-container"></div>
</div>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div id="panel"><div id="panel-content"></div><button class="m-btn" style="margin-top:20px;" onclick="closePanel()">é–‰ã˜ã‚‹</button></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyA7pcr0G4qEx0yLNWueZPdaeQoEBjFuoic", authDomain: "necotastudio-app.firebaseapp.com", projectId: "necotastudio-app", storageBucket: "necotastudio-app.firebasestorage.app", messagingSenderId: "1093173509944", appId: "1:1093173509944:web:5340935ddffdd49628cbcd" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆID
    const RAKUTEN_AFID = "51366796.8818598a.51366797.ddbb51d0";

    const vData = { "å®šç•ªè‘‰ç‰©": ["ã‚­ãƒ£ãƒ™ãƒ„", "ãƒ¬ã‚¿ã‚¹", "ç™½èœ", "ã»ã†ã‚Œã‚“è‰", "å°æ¾èœ", "ãƒãƒ³ã‚²ãƒ³èœ"], "é¦™å‘³ãƒãƒ¼ãƒ–": ["å¤§è‘‰", "èŒ—è·", "ãƒ‹ãƒ©", "ãƒ‘ã‚¯ãƒãƒ¼", "ãƒã‚¸ãƒ«", "ãƒ‘ã‚»ãƒª", "ãƒ«ãƒƒã‚³ãƒ©"], "ã‚µãƒ©ãƒ€è‘‰": ["ã‚±ãƒ¼ãƒ«", "æ°´èœ", "ãƒ™ãƒ“ãƒ¼ãƒªãƒ¼ãƒ•", "ãƒˆãƒ¬ãƒ“ã‚¹", "ã‚µãƒ‹ãƒ¼ãƒ¬ã‚¿ã‚¹"], "ãã®ä»–": ["æ˜æ—¥è‘‰", "ãƒ¢ãƒ­ãƒ˜ã‚¤ãƒ¤", "è±†è‹—", "æ˜¥èŠ", "ã‚»ãƒ­ãƒª"] };
    const dData = { "å’Œé¢¨": { "ãŠæµ¸ã—": 2, "èƒ¡éº»å’Œãˆ": 2, "æµ…æ¼¬ã‘": 2, "å¤©ã·ã‚‰": 3, "é‡èœç‚’ã‚": 3, "ç™½å’Œãˆ": 3, "ç­‘å‰ç…®": 3, "å†·å¥´ã®å¤§è‘‰ã®ã›": 2, "èŒ—è·ã®ç”˜é…¢æ¼¬ã‘": 2 }, "æ´‹é¢¨": { "ã‚µãƒ©ãƒ€": 2, "ãƒ­ãƒ¼ãƒ«ã‚­ãƒ£ãƒ™ãƒ„": 3, "ãƒã‚¸ãƒ«ãƒ‘ã‚¹ã‚¿": 2, "ãƒãƒˆãƒ•": 3, "ã»ã†ã‚Œã‚“è‰ã‚½ãƒ†ãƒ¼": 2, "ã‚³ãƒ¼ãƒ«ã‚¹ãƒ­ãƒ¼": 2, "ã‚±ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¹": 3, "ãƒ©ã‚¿ãƒˆã‚¥ã‚¤ãƒ¦": 4, "ãƒãƒ¼ãƒ‹ãƒ£ã‚«ã‚¦ãƒ€": 4 }, "ä¸­è¯ãƒ»ã‚¨ã‚¹ãƒ‹ãƒƒã‚¯": { "é’æ¤’è‚‰çµ²": 3, "å›é‹è‚‰": 3, "ãƒ‘ã‚¯ãƒãƒ¼ã‚µãƒ©ãƒ€": 3, "ç©ºèŠ¯èœç‚’ã‚": 3, "é¤ƒå­ï¼ˆãƒ‹ãƒ©ãŸã£ã·ã‚Šï¼‰": 4, "å…«å®èœ": 4, "ã‚¬ãƒ‘ã‚ªãƒ©ã‚¤ã‚¹": 3, "ç”Ÿæ˜¥å·»ã": 3 }, "ã‚¹ãƒ¼ãƒ—ãƒ»é£²ã¿ç‰©": { "é’æ±": 1, "ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼": 2, "é‡èœã‚¹ãƒ¼ãƒ—": 2, "ãƒŸãƒã‚¹ãƒˆãƒ­ãƒ¼ãƒ": 3, "å‘³å™Œæ±ï¼ˆè‘‰ç‰©å…¥ã‚Šï¼‰": 2, "ãƒã‚¿ãƒ¼ã‚¸ãƒ¥": 3 } };
    const rarities = { C: { color: "#9e9e9e", price: 20 }, U: { color: "#2196f3", price: 100 }, R: { color: "#9c27b0", price: 300 }, E: { color: "#ff9800", price: 800 }, L: { color: "#d4af37", price: 2500 } };
    const bookMaster = [ { id: 1, title: "ã‚­ãƒ£ãƒ™ãƒ„ã¨é¬¼é€€æ²»ã®æ—…", rare: "C", desc: "ã‚­ãƒ£ãƒ™ãƒ„ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸå°‘å¹´ãŒã€ãŠä¾›ã‚’é€£ã‚Œã¦é¬¼ãƒ¶å³¶ã‚’ç›®æŒ‡ã™æ˜”è©±é¢¨ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã€‚" }, { id: 2, title: "æ£®ã®é­”æ³•ä½¿ã„ã¨ç·‘ã®æ–", rare: "U", desc: "è¦‹ç¿’ã„é­”æ³•ä½¿ã„ãŒã€ã»ã†ã‚Œã‚“è‰ã®æ–ã§æ‘ã‚’æ•‘ã†æ„Ÿå‹•ã®ç‰©èªã€‚" }, { id: 3, title: "è¿·å®®ã®ãƒ¬ã‚¿ã‚¹å§«", rare: "R", desc: "æ·±ã„åœ°ä¸‹è¿·å®®ã«å›šã‚ã‚ŒãŸå§«ãŒã€ãƒ¬ã‚¿ã‚¹ã‚’è‚²ã¦ãªãŒã‚‰è„±å‡ºã‚’è©¦ã¿ã‚‹ã‚µãƒã‚¤ãƒãƒ«è­šã€‚" }, { id: 4, title: "éŠ€æ²³ã¸é£›ã¶ãƒãƒ¼ãƒ–èˆ¹", rare: "E", desc: "å®‡å®™ã®é¦™ã‚Šã‚’å®ˆã‚‹ãŸã‚ã€ãƒ‘ã‚¯ãƒãƒ¼å·ãŒæ˜Ÿã€…ã‚’å·¡ã‚‹SFã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ã€‚" }, { id: 5, title: "ç¿¡ç¿ ã®å¸æ›¸ã¨ç¦æ–­ã®è‘‰", rare: "L", desc: "necotastudioæãä¸‹ã‚ã—ã€‚å›³æ›¸å®¤ã®ä¸»ãŒèªã‚‹ã€ä¸–ç•Œã®çœŸå®Ÿã¨ç·‘ã®é­”å°æ›¸ã€‚" }, { id: 6, title: "å°æ¾èœã®é¨å£«é“", rare: "C", desc: "é‰„åˆ†è±Šå¯Œãªé§ã‚’çºã£ãŸé¨å£«ãŒã€å¹³å’Œã®ãŸã‚ã«æˆ¦ã†å‹‡æ°—ã‚ã‚‹ç‰©èªã€‚" }, { id: 7, title: "ãƒã‚¸ãƒ«ã¨ç§˜å¯†ã®èª¿å‘³æ–™", rare: "U", desc: "æ–™ç†ã®å‘³ã‚’åŠ‡çš„ã«å¤‰ãˆã‚‹ä¼èª¬ã®ãƒãƒ¼ãƒ–ã‚’æ¢ã™ã€ç¾é£Ÿã®å†’é™ºã€‚" }, { id: 8, title: "ç™½èœã®é™ã‚‹å¤œã«", rare: "R", desc: "é›ªã®ä»£ã‚ã‚Šã«ç™½èœãŒé™ã‚‹æ‘ã§èµ·ããŸã€å†¬ã®å¥‡è·¡ã®ç‰©èªã€‚" }, { id: 9, title: "ã‚±ãƒ¼ãƒ«ã®å·¨äººã¨ç©ºã®åº­", rare: "E", desc: "é›²ã®ä¸Šã«ã‚ã‚‹å·¨å¤§ãªã‚±ãƒ¼ãƒ«ã®åº­åœ’ã‚’å®ˆã‚‹ã€å¤©ç©ºã®å®ˆè­·è€…ã®è¨˜éŒ²ã€‚" }, { id: 10, title: "ä¼èª¬ã®é‡èœä½¿ã„ãƒ»ç¬¬ä¸€å·»", rare: "L", desc: "å¤ãˆã‚ˆã‚Šä¼ã‚ã‚‹ã€é‡èœã‚’æ“ã‚‹æˆ¦å£«ãŸã¡ã®æ­´å²ã‚’è¨˜ã—ãŸè‡³é«˜ã®ä¸€å†Šã€‚" }, { id: 11, title: "æ°´èœã®ã‚«ãƒ¼ãƒ†ãƒ³", rare: "C", desc: "é¢¨ã«æºã‚Œã‚‹æ°´èœã®éš™é–“ã‹ã‚‰è¦‹ãˆã‚‹ã€ä¸æ€è­°ãªç•°ä¸–ç•Œã¸ã®å…¥ã‚Šå£ã€‚" }, { id: 12, title: "èŒ—è·ã®é‡Œã®å¿˜ã‚Œç‰©", rare: "U", desc: "é£Ÿã¹ã‚‹ã¨ç‰©å¿˜ã‚Œã‚’ã™ã‚‹ã¨ã„ã†èŒ—è·ã€‚ãã®é‡Œã§ã€å°‘å¹´ãŒå¤±ã£ãŸè¨˜æ†¶ã‚’æ¢ã™ã€‚" }, { id: 13, title: "ãƒ‹ãƒ©ã¨å¤ªé™½ã®æ­Œ", rare: "R", desc: "å¼·ã„é¦™ã‚Šã¨å¤ªé™½ã®å…‰ã‚’æ„›ã™ã‚‹ç²¾éœŠãŸã¡ãŒã€å¤§åœ°ã‚’å…ƒæ°—ã«ã™ã‚‹æ­Œã€‚" }, { id: 14, title: "ãƒˆãƒ¬ãƒ“ã‚¹ã®èµ¤ã„å®çŸ³", rare: "E", desc: "é®®ã‚„ã‹ãªèµ¤è‰²ã‚’æŒã¤ãƒˆãƒ¬ãƒ“ã‚¹ã€‚ãã‚Œã‚’ç‹™ã†ç›—è³Šã¨å®ˆã‚‹æ‘äººã®çŸ¥æµæ¯”ã¹ã€‚" }, { id: 15, title: "necotastudio: å‰µé€ ã®è‘‰", rare: "L", desc: "ã‚¹ã‚¿ã‚¸ã‚ªã®èª•ç”Ÿç§˜è©±ã¨ã€ã“ã‚Œã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹ä½œå“ãŸã¡ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ç”»é›†ã€‚" }, { id: 16, title: "æ˜¥èŠã®å°ã•ãªæ‹", rare: "C", desc: "ã»ã‚è‹¦ã„æƒ³ã„ã‚’æŠ±ãˆã‚‹å°‘å¥³ãŒã€æ–™ç†ã‚’é€šã˜ã¦æˆé•·ã™ã‚‹é’æ˜¥çŸ­ç·¨é›†ã€‚" }, { id: 17, title: "å¤§è‘‰ã®é¢¨ã«ä¹—ã£ã¦", rare: "U", desc: "çˆ½ã‚„ã‹ãªé¢¨ã¨å…±ã«æ—…ã‚’ã™ã‚‹ã€å¤§è‘‰ã®ç¿¼ã‚’æŒã£ãŸå°‘å¹´ãŸã¡ã®ç‰©èªã€‚" }, { id: 18, title: "ãƒ¢ãƒ­ãƒ˜ã‚¤ãƒ¤ç‹å›½ã®ç‹å† ", rare: "R", desc: "ãƒãƒãƒãƒã—ãŸä¸æ€è­°ãªæ£®ã®å¥¥ã«ã‚ã‚‹ã€ãƒ¢ãƒ­ãƒ˜ã‚¤ãƒ¤ç‹å›½ã®ç¹æ „ã®ç§˜å¯†ã€‚" }, { id: 19, title: "æ˜æ—¥è‘‰ã®å¸Œæœ›", rare: "E", desc: "ä»Šæ—¥æ‘˜ã‚“ã§ã‚‚æ˜æ—¥ã«ã¯èŠ½å¹ãã€‚çµ¶æœ›ã«ç«‹ã¡å‘ã‹ã†äººã€…ã«è´ˆã‚‹å¿œæ´æ­Œã€‚" }, { id: 20, title: "è±†è‹—ã®ç„¡é™ãƒ«ãƒ¼ãƒ—", rare: "C", desc: "åˆ‡ã£ã¦ã‚‚ã¾ãŸç”Ÿãˆã¦ãã‚‹ã€‚ãã‚“ãªè±†è‹—ã®ã‚ˆã†ãªã€çµ‚ã‚ã‚‰ãªã„æ¥½ã—ã„æ—¥å¸¸ã€‚" } ];

    let myLeaves = null; 
    let myBooks = [];
    let dailyLog = [];
    let currentMode = 'veg';
    const todayStr = new Date().toLocaleDateString("ja-JP");

    window.login = () => signInWithPopup(auth, provider);
    
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('logged-in-actions').style.display = 'block';
            document.getElementById('user-display').innerText = `ğŸŒ¿ ${user.displayName} ã•ã‚“`;
            await loadData(user.uid);
        } else {
            myLeaves = 0; 
            document.getElementById('login-btn').style.display = 'flex';
            document.getElementById('logged-in-actions').style.display = 'none';
            document.getElementById('user-display').innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ä¿å­˜";
            updateUI();
        }
    });

    async function loadData(uid) {
        try {
            const docSnap = await getDoc(doc(db, "leafy_library", uid));
            if (docSnap.exists()) {
                const d = docSnap.data();
                myLeaves = d.leaves ?? 0;
                myBooks = d.books || [];
                dailyLog = (d.lastDate === todayStr) ? (d.dailyLog || []) : [];
            } else {
                myLeaves = 0;
            }
            updateUI();
        } catch (e) { 
            console.error("Load Error:", e); 
            myLeaves = 0; 
        }
    }

    async function sync() {
        const user = auth.currentUser;
        if (!user || myLeaves === null) return;
        try {
            await setDoc(doc(db, "leafy_library", user.uid), { 
                leaves: myLeaves, books: myBooks, dailyLog: dailyLog, lastDate: todayStr 
            }, { merge: true });
        } catch (e) { console.error("Sync Error:", e); }
    }

    window.addEntry = async () => {
        if (myLeaves === null) return;
        const cat = document.getElementById('cat-select').value;
        const itemName = document.getElementById('item-select').value;
        let points = 1;
        if (currentMode === 'dish') { points = dData[cat][itemName] || 2; }
        const currentDailyTotal = dailyLog.reduce((sum, log) => sum + log.val, 0);
        if (currentDailyTotal + points > 50) { alert("1æ—¥ã®ä¸Šé™ã¯50æšã§ã™ğŸŒ¿"); return; }
        
        const entry = { id: Date.now(), name: itemName, val: points };
        dailyLog.unshift(entry);
        myLeaves += points;
        updateUI();
        await sync();
    };

    window.deleteLog = async (logId) => {
        if (myLeaves === null) return;
        const index = dailyLog.findIndex(l => l.id === logId);
        if (index !== -1) {
            myLeaves -= dailyLog[index].val;
            dailyLog.splice(index, 1);
            updateUI();
            await sync();
        }
    };

    window.buyBook = async (id) => {
        if (myLeaves === null) return;
        const b = bookMaster.find(x => x.id === id);
        if(myLeaves >= rarities[b.rare].price) {
            myLeaves -= rarities[b.rare].price; 
            myBooks.push(id);
            updateUI(); 
            await sync();
        }
    };

    function updateUI() {
        const totalEl = document.getElementById('leaf-total');
        if (totalEl) totalEl.innerText = (myLeaves === null) ? "..." : myLeaves;
        const dailyCount = dailyLog.reduce((sum, log) => sum + log.val, 0);
        const countTxt = document.getElementById('daily-count-txt');
        if (countTxt) countTxt.innerText = dailyCount;
        const libCount = document.getElementById('lib-book-count');
        if (libCount) libCount.innerText = myBooks.length;
        renderLog();
        renderStore();
    }

    function renderLog() {
        const list = document.getElementById('log-list');
        if (dailyLog.length === 0) { list.innerHTML = '<p style="font-size: 0.7rem; color: #ccc; text-align: center;">ä»Šæ—¥ã®ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</p>'; return; }
        list.innerHTML = dailyLog.map(log => `
            <div class="log-item">
                <span>${log.val >= 2 ? 'ğŸ³' : 'ğŸŒ¿'} ${log.name}</span>
                <div><span style="font-weight:bold; margin-right:10px;">+${log.val}</span><i class="fas fa-times-circle log-delete" onclick="deleteLog(${log.id})"></i></div>
            </div>
        `).join('');
    }

    window.shareOnX = () => {
        const dailyCount = dailyLog.reduce((sum, log) => sum + log.val, 0);
        const text = `ä»Šæ—¥ã®è‘‰ã£ã±ç²å¾—æ•°ã¯ ${dailyCount} æšï¼ğŸƒ\nç¾åœ¨ã®è”µæ›¸æ•°ã¯ ${myBooks.length} å†Šã§ã™ã€‚ğŸ“š\n#LeafyLibrary #necotastudio`;
        const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(location.href)}`;
        window.open(url, '_blank');
    };

    window.openLibrary = () => { renderLibrary(); document.getElementById('library-page').style.display = 'flex'; };
    window.closeLibrary = () => { document.getElementById('library-page').style.display = 'none'; };

    function renderLibrary() {
        const container = document.getElementById('shelf-rows-container');
        container.innerHTML = "";
        let row = document.createElement('div'); row.className = 'shelf-row';
        myBooks.forEach((bid, index) => {
            if (index > 0 && index % 12 === 0) { container.appendChild(row); row = document.createElement('div'); row.className = 'shelf-row'; }
            const b = bookMaster.find(x => x.id === bid);
            if (!b) return;
            const spine = document.createElement('div');
            spine.className = `book-spine`;
            spine.style.backgroundColor = rarities[b.rare].color;
            spine.onclick = () => showPanel(b.id, 'book');
            row.appendChild(spine);
        });
        container.appendChild(row);
    }

    function renderStore() {
        const grid = document.getElementById('store-grid'); grid.innerHTML = "";
        bookMaster.forEach(b => {
            const r = rarities[b.rare];
            const isBought = myBooks.includes(b.id);
            const canBuy = myLeaves !== null && myLeaves >= r.price;
            grid.innerHTML += `<div style="background:white; padding:10px; border-radius:15px; border:2px solid ${r.color}; text-align:center;">
                <span style="font-size:10px; background:${r.color}; color:white; padding:2px 5px; border-radius:5px;">${b.rare}</span><br>
                <b style="font-size:0.8rem;">${b.title}</b><br>
                <span style="color:red; font-weight:bold;">${r.price}æš</span><br>
                <button onclick="buyBook(${b.id})" style="width:100%; border:none; border-radius:5px; padding:8px; margin-top:5px; background:${canBuy?r.color:'#ccc'}; color:white;" ${isBought||!canBuy?'disabled':''}>${isBought?'æ‰€è”µæ¸ˆ':'è³¼å…¥'}</button>
            </div>`;
        });
    }

    window.showPanel = (id, type) => {
        let title, desc, searchKey;
        if (type === 'book') {
            const b = bookMaster.find(x => x.id === id);
            title = b.title; desc = b.desc; searchKey = b.title;
        } else {
            title = id; 
            desc = `${title}ã‚’é£Ÿã¹ã¦ã€å¥åº·ãªæ¯æ—¥ã‚’é€ã‚Šã¾ã—ã‚‡ã†ã€‚necotastudioã¯ã‚ãªãŸã®ã€Œç·‘ã®ã‚ã‚‹ç”Ÿæ´»ã€ã‚’å¿œæ´ã—ã¾ã™ã€‚`;
            searchKey = title;
        }
        
        // --- æ¥½å¤©ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ã®ç”Ÿæˆï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
        const rakutenUrl = `https://hb.afl.rakuten.co.jp/hgc/${RAKUTEN_AFID}/?pc=${encodeURIComponent('https://search.rakuten.co.jp/search/mall/' + searchKey + '/')}`;
        
        const html = `<div style="text-align:center;">
            <h2 style="color:var(--dark-green);">ã€${title}ã€</h2>
            <p style="text-align:left; font-size:0.9rem; line-height:1.6; background:#f9f9f9; padding:15px; border-radius:10px;">${desc}</p>
            <button class="rakuten-btn" onclick="window.open('${rakutenUrl}')"><i class="fas fa-shopping-bag"></i> æ¥½å¤©ã§æ¢ã™</button>
        </div>`;
        document.getElementById('panel-content').innerHTML = html;
        document.getElementById('panel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    };

    window.openShopping = () => {
        const item = document.getElementById('item-select').value;
        showPanel(item, 'item');
    };

    window.switchMode = (m) => {
        currentMode = m;
        document.getElementById('m-veg').className = m==='veg' ? 'm-btn active' : 'm-btn';
        document.getElementById('m-dish').className = m==='dish' ? 'm-btn active' : 'm-btn';
        const catS = document.getElementById('cat-select'); catS.innerHTML = "";
        if (m === 'veg') { Object.keys(vData).forEach(c => catS.add(new Option(c, c))); }
        else { Object.keys(dData).forEach(c => catS.add(new Option(c, c))); }
        updateItemList();
    };

    window.updateItemList = () => {
        const cat = document.getElementById('cat-select').value;
        const itemS = document.getElementById('item-select'); itemS.innerHTML = "";
        if (currentMode === 'veg') { vData[cat].forEach(i => itemS.add(new Option(i, i))); }
        else { Object.keys(dData[cat]).forEach(i => { const pts = dData[cat][i]; itemS.add(new Option(`${i} (+${pts})`, i)); }); }
    };

    window.safeGoBack = async (e) => {
        if (e) e.preventDefault();
        const user = auth.currentUser;
        if (user && myLeaves !== null) { 
            const display = document.getElementById('user-display');
            if (display) display.innerText = "ä¿å­˜ä¸­...";
            try { await sync(); } catch (err) { console.error("Save failed", err); }
        }
        window.location.href = "https://jyonjyon-code.github.io/hirumeshi/";
    };

    window.closePanel = () => { document.getElementById('panel').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };

    switchMode('veg');
</script>
</body>
</html>
