<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leafy Library | necotastudio</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --wood-brown: #5D4037;
            --paper-white: #F5F5DC;
            --rare-c: #9e9e9e; --rare-u: #2196f3; --rare-r: #9c27b0; --rare-e: #ff9800; --rare-l: #d4af37;
        }
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--paper-white); color: var(--wood-brown); margin: 0; padding-bottom: 80px; display: flex; flex-direction: column; align-items: center; }
        header { background: var(--primary-green); color: white; width: 100%; padding: 15px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        .back-home { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: white; text-decoration: none; font-size: 0.8rem; border: 1px solid white; padding: 4px 10px; border-radius: 20px; font-weight: bold; background: rgba(0,0,0,0.1); cursor: pointer; }
        .container { width: 95%; max-width: 500px; margin: 10px 0; box-sizing: border-box; }
        .status-box { background: white; padding: 15px; border-radius: 20px; text-align: center; border: 2px solid #ddd; }
        .leaf-display { font-size: 2rem; font-weight: 900; color: var(--dark-green); margin: 5px 0; }
        .limit-bar-container { background: #eee; height: 8px; border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .limit-bar { background: var(--primary-green); height: 100%; width: 0%; transition: 0.3s; }
        .bookshelf { background-color: var(--wood-brown); padding: 15px; border-radius: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 5px; border-bottom: 15px solid #3e2723; box-shadow: inset 0 -5px 15px rgba(0,0,0,0.4); }
        .book-spine { width: 18px; height: 65px; border-left: 2px solid rgba(255,255,255,0.2); border-radius: 2px; cursor: pointer; transition: 0.2s; }
        .book-spine:hover { transform: translateY(-10px); }
        .glow-l { box-shadow: 0 0 12px var(--rare-l); border: 1px solid white; }
        .input-card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 3px solid var(--primary-green); }
        .m-btn { flex: 1; padding: 10px; border: 2px solid var(--primary-green); background: white; border-radius: 12px; cursor: pointer; font-weight: bold; font-family: inherit; }
        .m-btn.active { background: var(--primary-green); color: white; }
        .count-btn { padding: 15px 0; border-radius: 12px; border: 2px solid var(--primary-green); background: white; color: var(--dark-green); font-weight: 900; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 0 var(--primary-green); }
        .count-btn:active { transform: translateY(3px); box-shadow: none; }
        .report-box { background: #E3F2FD; padding: 15px; border-radius: 15px; text-align: center; margin-top: 20px; border: 1px dashed #2196F3; }
        .share-btn { background: #000; color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; margin-top: 10px; }
        .ad-space { background: #fff; border: 1px solid #eee; padding: 20px; margin-top: 20px; border-radius: 15px; text-align: center; color: #888; font-size: 0.8rem; }
        .footer-links { margin-top: 30px; text-align: center; font-size: 0.8rem; }
        .footer-links a { color: var(--wood-brown); margin: 0 10px; text-decoration: none; font-weight: bold; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 100; display:none; }
        #panel { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:85%; max-width:400px; background:white; border-radius:30px; padding:30px; z-index: 101; display:none; text-align:center; border: 6px solid var(--primary-green); }
    </style>
</head>
<body>

<header>
    <div class="back-home" onclick="safeGoBack()"><i class="fas fa-chevron-left"></i> æˆ»ã‚‹</div>
    <h1 style="margin:0; font-size: 1.5rem;">Leafy Library</h1>
</header>

<div class="container status-box">
    <div id="user-display" style="font-size: 12px; color: #666; margin-bottom: 5px;">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="leaf-display">ğŸƒ <span id="leaf-total">0</span> <small style="font-size: 1rem;">æš</small></div>
    <div class="limit-info" style="font-size:11px; display:flex; justify-content:space-between;">
        <span>ä»Šæ—¥ã®åè”µä¸Šé™</span>
        <span><span id="daily-count-txt">0</span> / 50 æš</span>
    </div>
    <div class="limit-bar-container"><div id="limit-bar" class="limit-bar"></div></div>
    <button id="login-btn" class="count-btn" style="width: 100%; font-size: 1rem; padding: 8px; margin-top:15px; display:none;" onclick="login()">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div class="container"><div class="bookshelf" id="my-shelf"></div></div>

<div class="container input-card">
    <div style="display:flex; gap:8px; margin-bottom:15px;">
        <button id="m-veg" class="m-btn active" onclick="switchMode('veg')">ğŸ¥¬ è‘‰ã£ã±</button>
        <button id="m-dish" class="m-btn" onclick="switchMode('dish')">ğŸ³ æ–™ç†</button>
    </div>
    <select id="cat-select" style="width:100%; padding:10px; border-radius:10px; margin-bottom:10px;" onchange="updateItemList()"></select>
    <select id="item-select" style="width:100%; padding:10px; border-radius:10px; margin-bottom:10px;"></select>
    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
        <button class="count-btn" onclick="earnLeaves(1)">+1</button>
        <button class="count-btn" onclick="earnLeaves(5)">+5</button>
        <button class="count-btn" onclick="earnLeaves(10)">+10</button>
        <button class="count-btn" style="background:#ff9800; color:white;" onclick="earnLeaves(30)">+30</button>
    </div>
    <button id="undo-btn" onclick="undoLast()" disabled style="float:right; margin-top:10px; padding:5px 15px; border-radius:15px; background:#f44336; color:white; border:none; cursor:pointer;">1ã¤æˆ»ã™</button>
</div>

<div class="container report-box">
    <div style="font-weight:bold; font-size:0.9rem;">ä»Šæ—¥ã®æ´»å‹•ã‚’å ±å‘Šã—ã‚ˆã†ï¼</div>
    <a id="x-share" href="#" target="_blank" class="share-btn"><i class="fab fa-x-twitter"></i> Xã§å ±å‘Šã™ã‚‹</a>
</div>

<div class="container ad-space">
    <i class="fas fa-shopping-basket"></i> <b>ãŠã™ã™ã‚ã®è‘‰ç‰©é‡èœãƒ»é“å…·</b><br>
    <div style="margin-top:10px; font-size:0.7rem;">
        <a href="https://hb.afl.rakuten.co.jp/hgc/43632f05.42a42095.43632f06.f6236b28/?pc=https%3A%2F%2Fwww.rakuten.co.jp%2F" target="_blank" style="color: #4CAF50; text-decoration: none;">æ¥½å¤©ã§æ–°é®®ãªè‘‰ã£ã±ã‚’è¦‹ã‚‹ ğŸŒ¿</a>
    </div>
</div>

<div class="container">
    <h3 style="border-left: 5px solid var(--primary-green); padding-left: 10px;">äº¤æ›æ‰€ (Store)</h3>
    <div id="store-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
</div>

<div class="footer-links">
    <a href="https://jyonjyon-code.github.io/hirumeshi/"><i class="fas fa-home"></i> ã²ã‚‹ã‚ã—ãƒ›ãƒ¼ãƒ </a>
    <a href="https://www.instagram.com/necotastudio" target="_blank"><i class="fab fa-instagram"></i> necotastudio</a>
    <p style="color:#aaa; font-size:10px; margin-top:15px;">&copy; 2026 necotastudio</p>
</div>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div id="panel"><div id="panel-content"></div><button class="m-btn" style="margin-top:20px;" onclick="closePanel()">é–‰ã˜ã‚‹</button></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyA7pcr0G4qEx0yLNWueZPdaeQoEBjFuoic", authDomain: "necotastudio-app.firebaseapp.com", projectId: "necotastudio-app", storageBucket: "necotastudio-app.firebasestorage.app", messagingSenderId: "1093173509944", appId: "1:1093173509944:web:5340935ddffdd49628cbcd" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- å³é¸ãƒ»è‘‰ã£ã±ãƒ‡ãƒ¼ã‚¿ ---
    const vData = { 
        "å®šç•ªè‘‰ç‰©": ["ã‚­ãƒ£ãƒ™ãƒ„", "ãƒ¬ã‚¿ã‚¹", "ç™½èœ", "ã»ã†ã‚Œã‚“è‰", "å°æ¾èœ", "ãƒãƒ³ã‚²ãƒ³èœ"],
        "é¦™å‘³ãƒ»ãƒãƒ¼ãƒ–": ["å¤§è‘‰", "èŒ—è·", "ãƒ‹ãƒ©", "ãƒ‘ã‚¯ãƒãƒ¼", "ãƒã‚¸ãƒ«", "ãƒ‘ã‚»ãƒª", "ãƒ«ãƒƒã‚³ãƒ©"],
        "ã‚µãƒ©ãƒ€è‘‰": ["ã‚±ãƒ¼ãƒ«", "æ°´èœ", "ã‚µãƒ‹ãƒ¼ãƒ¬ã‚¿ã‚¹", "ãƒ™ãƒ“ãƒ¼ãƒªãƒ¼ãƒ•", "ã‚»ãƒ­ãƒªè‘‰", "ãƒˆãƒ¬ãƒ“ã‚¹"],
        "å±±èœãƒ»ãã®ä»–": ["æ˜æ—¥è‘‰", "ãƒ¢ãƒ­ãƒ˜ã‚¤ãƒ¤", "è±†è‹—", "æ˜¥èŠ"]
    };
    const dData = { 
        "å’Œé¢¨ã®è‘‰": ["ãŠæµ¸ã—", "èƒ¡éº»å’Œãˆ", "æµ…æ¼¬ã‘", "æ˜¥èŠã®å¤©ã·ã‚‰", "å¤§è‘‰åŒ…ã¿ç„¼ã"],
        "æ´‹é¢¨ã®è‘‰": ["ã‚·ãƒ¼ã‚¶ãƒ¼ã‚µãƒ©ãƒ€", "ãƒ­ãƒ¼ãƒ«ã‚­ãƒ£ãƒ™ãƒ„", "ãƒã‚¸ãƒ«ãƒ‘ã‚¹ã‚¿", "ã»ã†ã‚Œã‚“è‰ã‚½ãƒ†ãƒ¼"],
        "æ¶²çŠ¶ã®è‘‰": ["é’æ±", "ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼", "è‘‰é‡èœã‚¹ãƒ¼ãƒ—"]
    };
    const rarities = { C: { color: "#9e9e9e", price: 20 }, U: { color: "#2196f3", price: 100 }, R: { color: "#9c27b0", price: 300 }, E: { color: "#ff9800", price: 800 }, L: { color: "#d4af37", price: 2500 } };
    
    // --- ã¼ã‹ã—ãŸã‚¿ã‚¤ãƒˆãƒ«ã«å¤‰æ›´ ---
    const bookMaster = [
        { id: 1, title: "ã‚­ãƒ£ãƒ™ãƒ„ã¨é¬¼é€€æ²»ã®æ—…", rare: "C", desc: "å¤§ããªã‚­ãƒ£ãƒ™ãƒ„ã®ä¸­ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸå°‘å¹´ãŒã€ãŠä¾›ã‚’é€£ã‚Œã¦é¬¼ã‚’é€€æ²»ã™ã‚‹ä¸æ€è­°ãªæ˜”è©±ã€‚", affLink: "https://hb.afl.rakuten.co.jp/hgc/43632f05.42a42095.43632f06.f6236b28/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fgp-itcl%2F10000040%2F" },
        { id: 2, title: "æ£®ã®é­”æ³•ä½¿ã„ã¨ç·‘ã®æ–", rare: "U", desc: "é­”æ³•å­¦æ ¡ã«é€šã†å°‘å¹´ãŒã€è‘‰ã£ã±ã‚’æ“ã‚‹é­”æ³•ã§ãƒ”ãƒ³ãƒã‚’åˆ‡ã‚ŠæŠœã‘ã‚‹å†’é™ºãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ã€‚", affLink: "https://hb.afl.rakuten.co.jp/hgc/43632f05.42a42095.43632f06.f6236b28/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbaroness%2Ff600%2F" },
        { id: 3, title: "è¿·å®®ã®ãƒ¬ã‚¿ã‚¹å§«", rare: "R", desc: "é«˜ã„å¡”ã«å¹½é–‰ã•ã‚ŒãŸå§«ãŒã€é•·ã„é«ªã‚’ä½¿ã£ã¦é€ƒã’å‡ºã™â€¦ã®ã§ã¯ãªãã€ãƒ¬ã‚¿ã‚¹ã‚’è‚²ã¦ã¦ç”Ÿãå»¶ã³ã‚‹ç‰©èªã€‚", affLink: "https://hb.afl.rakuten.co.jp/hgc/43632f05.42a42095.43632f06.f6236b28/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbook%2F17354385%2F" },
        { id: 4, title: "éŠ€æ²³ã¸é£›ã¶ãƒãƒ¼ãƒ–èˆ¹", rare: "E", desc: "å®‡å®™ã‚’æ—…ã™ã‚‹èˆ¹ä¹—ã‚ŠãŸã¡ãŒã€é¦™ã‚Šã®åŠ›ã§æ˜Ÿã€…ã‚’æ•‘ã†SFãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼å¤§ä½œã€‚", affLink: "https://hb.afl.rakuten.co.jp/hgc/43632f05.42a42095.43632f06.f6236b28/?pc=https%3A%2F%2Fwww.rakuten.co.jp%2F" },
        { id: 5, title: "ç¿¡ç¿ ã®å¸æ›¸ã¨ç¦æ–­ã®è‘‰", rare: "L", desc: "necotastudioæãä¸‹ã‚ã—ã€‚å›³æ›¸é¤¨ã®å¥¥æ·±ãã«çœ ã‚‹ã€Œä¸–ç•Œã‚’ç·‘ã«å¤‰ãˆã‚‹è‘‰ã€ã‚’å·¡ã‚‹å£®å¤§ãªç‰©èªã€‚", affLink: "https://hb.afl.rakuten.co.jp/hgc/43632f05.42a42095.43632f06.f6236b28/?pc=https%3A%2F%2Fitem.rakuten.co.jp%2Fbook%2F17354385%2F" }
    ];

    let myLeaves = 0, myBooks = [], dailyCount = 0, lastAdd = 0, todayStr = new Date().toLocaleDateString();

    window.login = () => signInWithPopup(auth, provider);
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('user-display').innerText = `ğŸŒ¿ ${user.displayName} ã•ã‚“`;
            await loadData(user.uid);
        } else {
            document.getElementById('login-btn').style.display = 'block';
            document.getElementById('user-display').innerText = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„";
        }
    });

    async function loadData(uid) {
        const docSnap = await getDoc(doc(db, "leafy_library", uid));
        if (docSnap.exists()) {
            const d = docSnap.data();
            myLeaves = d.leaves || 0; myBooks = d.books || [];
            dailyCount = (d.lastDate === todayStr) ? (d.dailyCount || 0) : 0;
        }
        updateUI();
    }

    async function sync() {
        const user = auth.currentUser;
        if (user) {
            await setDoc(doc(db, "leafy_library", user.uid), { leaves: myLeaves, books: myBooks, dailyCount: dailyCount, lastDate: todayStr }, { merge: true });
        }
        updateXLink();
    }

    window.earnLeaves = async (val) => {
        if (dailyCount + val > 50) { alert("1æ—¥ã®ä¸Šé™ã¯50æšã§ã™ã€‚"); return; }
        myLeaves += val; dailyCount += val; lastAdd = val;
        document.getElementById('undo-btn').disabled = false;
        updateUI(); await sync();
    };

    window.undoLast = async () => {
        if (lastAdd > 0) {
            myLeaves -= lastAdd; dailyCount -= lastAdd; lastAdd = 0;
            document.getElementById('undo-btn').disabled = true;
            updateUI(); await sync();
        }
    };

    window.buyBook = async (id) => {
        const b = bookMaster.find(x => x.id === id);
        if(myLeaves >= rarities[b.rare].price) {
            myLeaves -= rarities[b.rare].price; myBooks.push(id);
            updateUI(); await sync();
        }
    };

    function updateUI() {
        document.getElementById('leaf-total').innerText = myLeaves;
        document.getElementById('daily-count-txt').innerText = dailyCount;
        document.getElementById('limit-bar').style.width = `${(dailyCount/50)*100}%`;
        renderShelf(); renderStore(); updateXLink();
    }

    function renderShelf() {
        const shelf = document.getElementById('my-shelf'); shelf.innerHTML = "";
        myBooks.forEach(bid => {
            const b = bookMaster.find(x => x.id === bid);
            if (!b) return;
            const spine = document.createElement('div');
            spine.className = `book-spine ${b.rare==='L' ? 'glow-l' : ''}`;
            spine.style.backgroundColor = rarities[b.rare].color;
            spine.onclick = () => showPanel(b.id);
            shelf.appendChild(spine);
        });
    }

    function renderStore() {
        const grid = document.getElementById('store-grid'); grid.innerHTML = "";
        bookMaster.forEach(b => {
            const r = rarities[b.rare];
            const isBought = myBooks.includes(b.id);
            const canBuy = myLeaves >= r.price;
            grid.innerHTML += `<div style="background:white; padding:10px; border-radius:15px; border:2px solid ${r.color}; text-align:center;">
                <span style="font-size:10px; background:${r.color}; color:white; padding:2px 5px; border-radius:5px;">${b.rare}</span><br>
                <b style="font-size:0.8rem;">${b.title}</b><br>
                <span style="color:red; font-weight:bold;">${r.price}æš</span><br>
                <button onclick="buyBook(${b.id})" style="width:100%; border:none; border-radius:5px; padding:5px; margin-top:5px; background:${canBuy?r.color:'#ccc'}; color:white;" ${isBought||!canBuy?'disabled':''}>${isBought?'æ‰€è”µæ¸ˆ':'è³¼å…¥'}</button>
            </div>`;
        });
    }

    window.showPanel = (bid) => {
        const b = bookMaster.find(x => x.id === bid);
        if (!b) return;
        const html = `
            <div style="text-align:center;">
                <span style="background:${rarities[b.rare].color}; color:white; padding:2px 10px; border-radius:10px; font-size:0.7rem;">${b.rare}</span>
                <h2 style="margin:10px 0; color:var(--dark-green);">ã€${b.title}ã€</h2>
                <div style="background:#fdfdfd; padding:15px; border-radius:15px; border:1px solid #eee; text-align:left; font-size:0.9rem; line-height:1.6; margin-bottom:15px;">${b.desc}</div>
                <div style="background:#fff0f0; padding:12px; border-radius:15px; border:1px solid #ffcdd2;">
                    <p style="font-size:0.7rem; color:#d32f2f; margin:0 0 8px 0; font-weight:bold;">ï¼¼ é–¢é€£ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¥½å¤©ã§ãƒã‚§ãƒƒã‚¯ ï¼</p>
                    <a href="${b.affLink}" target="_blank" style="text-decoration:none;">
                        <button style="background:#bf0000; color:white; border:none; padding:10px 20px; border-radius:10px; font-weight:bold; cursor:pointer; width:100%; font-size:1rem;"><i class="fas fa-shopping-cart"></i> æ¥½å¤©ã§æ¢ã™</button>
                    </a>
                </div>
            </div>`;
        document.getElementById('panel-content').innerHTML = html;
        document.getElementById('panel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    };

    window.switchMode = (m) => {
        document.getElementById('m-veg').className = m==='veg' ? 'm-btn active' : 'm-btn';
        document.getElementById('m-dish').className = m==='dish' ? 'm-btn active' : 'm-btn';
        const catS = document.getElementById('cat-select'); catS.innerHTML = "";
        const target = m==='veg' ? vData : dData;
        Object.keys(target).forEach(c => catS.add(new Option(c, c)));
        updateItemList();
    };

    window.updateItemList = () => {
        const cat = document.getElementById('cat-select').value;
        const itemS = document.getElementById('item-select'); itemS.innerHTML = "";
        const target = (vData[cat] || dData[cat]);
        target.forEach(i => itemS.add(new Option(i, i)));
    };

    function updateXLink() {
        const text = encodeURIComponent(`Leafy Libraryã§ä»Šæ—¥ ${dailyCount}æš ã®è‘‰ã£ã±ã‚’é›†ã‚ã¾ã—ãŸğŸŒ¿ ç¾åœ¨ã®æ‰€è”µæ•°ã¯ ${myBooks.length}å†Šï¼ #LeafyLibrary #necotastudio`);
        document.getElementById('x-share').href = `https://twitter.com/intent/tweet?text=${text}`;
    }

    window.safeGoBack = async () => {
        const user = auth.currentUser;
        if (user) await sync();
        window.location.href = "https://jyonjyon-code.github.io/hirumeshi/";
    };

    window.closePanel = () => { document.getElementById('panel').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };

    switchMode('veg');
</script>
</body>
</html>
