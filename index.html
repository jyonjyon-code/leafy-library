<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leafy Library | necotastudio</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --wood-brown: #5D4037;
            --paper-white: #F5F5DC;
            /* ãƒ¬ã‚¢åº¦ã‚«ãƒ©ãƒ¼ */
            --rare-c: #9e9e9e; --rare-u: #2196f3; --rare-r: #9c27b0; --rare-e: #ff9800; --rare-l: #d4af37;
        }

        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--paper-white); color: var(--wood-brown); margin: 0; padding-bottom: 50px; display: flex; flex-direction: column; align-items: center; }
        
        header { background: var(--primary-green); color: white; width: 100%; padding: 15px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        
        .container { width: 95%; max-width: 500px; margin: 10px 0; box-sizing: border-box; }

        /* ãƒ­ã‚°ã‚¤ãƒ³/ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .auth-box { background: white; padding: 10px; border-radius: 15px; text-align: center; border: 1px solid #ddd; margin-bottom: 10px; }
        .btn-login { background: white; border: 1px solid #ccc; padding: 10px; border-radius: 12px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; font-family: inherit; }
        .user-info { font-size: 13px; color: var(--dark-green); font-weight: 900; }
        .leaf-display { font-size: 1.8rem; font-weight: 900; color: var(--dark-green); text-align: center; margin: 10px 0; }

        /* æœ¬æ£š */
        .bookshelf {
            background-color: var(--wood-brown); padding: 15px; border-radius: 12px; min-height: 70px;
            display: flex; flex-wrap: wrap; gap: 5px; border-bottom: 12px solid #3e2723;
            box-shadow: inset 0 -5px 15px rgba(0,0,0,0.4);
        }
        .book-spine { width: 18px; height: 60px; border-left: 2px solid rgba(255,255,255,0.2); border-radius: 2px; cursor: pointer; transition: 0.2s; }
        .book-spine:hover { transform: translateY(-8px); }
        .glow-l { box-shadow: 0 0 10px var(--rare-l); border: 1px solid white; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆãƒãƒãƒãƒãƒœã‚¿ãƒ³å¼ï¼‰ */
        .input-card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 3px solid var(--primary-green); }
        .mode-tabs { display: flex; gap: 8px; margin-bottom: 15px; }
        .m-btn { flex: 1; padding: 10px; border: 2px solid var(--primary-green); background: white; border-radius: 12px; cursor: pointer; font-weight: bold; font-family: inherit; }
        .m-btn.active { background: var(--primary-green); color: white; }
        
        select { padding: 12px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; width: 100%; font-family: inherit; margin-bottom: 10px; background: #fff; }
        
        .count-btn-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .count-btn { 
            padding: 15px 0; border-radius: 12px; border: 2px solid var(--primary-green); background: white; 
            color: var(--dark-green); font-weight: 900; font-size: 1.2rem; cursor: pointer; font-family: inherit;
            box-shadow: 0 4px 0 var(--primary-green); transition: 0.1s;
        }
        .count-btn:active { transform: translateY(3px); box-shadow: none; }
        .count-btn.special { background: #ff9800; border-color: #e68a00; color: white; box-shadow: 0 4px 0 #cc7a00; }

        /* æœ¬å±‹ */
        .store-header { display: flex; overflow-x: auto; gap: 8px; padding: 10px 0; }
        .tab-btn { padding: 8px 18px; border-radius: 20px; border: 1px solid var(--primary-green); background: white; white-space: nowrap; cursor: pointer; font-family: inherit; font-size: 0.85rem; }
        .tab-btn.active { background: var(--primary-green); color: white; }
        
        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
        .store-item { background: white; border-radius: 15px; padding: 12px; text-align: center; border: 2px solid #eee; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .rare-tag { position: absolute; top:0; right:0; font-size: 0.7rem; color: white; padding: 3px 8px; border-bottom-left-radius: 10px; font-weight: bold; }
        
        .buy-btn { width: 100%; padding: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 8px; font-family: inherit; }
        .buy-btn:disabled { background: #eee !important; color: #aaa; cursor: default; }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index: 100; display:none; }
        #panel { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:85%; max-width:400px; background:white; border-radius:30px; padding:30px; z-index: 101; display:none; text-align:center; border: 6px solid var(--primary-green); box-sizing: border-box;}
        .btn-close { background: var(--wood-brown); color: white; padding: 12px 40px; border-radius: 50px; border: none; margin-top: 20px; font-weight: bold; font-family: inherit; cursor: pointer; }
    </style>
</head>
<body>

<header onclick="location.reload()">
    <h1 style="margin:0; font-size: 1.6rem;">Leafy Library</h1>
    <small>necotastudio collection</small>
</header>

<div class="container leaf-display">
    ğŸƒ <span id="leaf-total">0</span> <small style="font-size: 1rem;">æš</small>
</div>

<div class="container auth-box">
    <div id="user-display" class="user-info" style="display:none;"></div>
    <button id="login-btn" class="btn-login" onclick="login()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="18"> Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦åŒæœŸ
    </button>
</div>

<div class="container">
    <div class="bookshelf" id="my-shelf"></div>
</div>

<div class="container input-card">
    <div class="mode-tabs">
        <button id="m-veg" class="m-btn active" onclick="switchMode('veg')">ğŸ¥¬ é‡èœ</button>
        <button id="m-dish" class="m-btn" onclick="switchMode('dish')">ğŸ³ æ–™ç†</button>
    </div>
    
    <select id="cat-select" onchange="updateItemList()"></select>
    <select id="item-select"></select>

    <div class="count-btn-group">
        <button class="count-btn" onclick="earnLeaves(1)">+1</button>
        <button class="count-btn" onclick="earnLeaves(5)">+5</button>
        <button class="count-btn" onclick="earnLeaves(10)">+10</button>
        <button class="count-btn special" onclick="earnLeaves(30)">+30</button>
    </div>
</div>

<div class="container">
    <h3 style="margin-bottom:5px; border-left: 5px solid var(--primary-green); padding-left: 10px;">æœ¬å±‹ã®æ£š (Store)</h3>
    <div class="store-header" id="store-tabs"></div>
    <div class="store-grid" id="store-grid"></div>
</div>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div id="panel">
    <div id="panel-content"></div>
    <button class="btn-close" onclick="closePanel()">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA7pcr0G4qEx0yLNWueZPdaeQoEBjFuoic",
        authDomain: "necotastudio-app.firebaseapp.com",
        projectId: "necotastudio-app",
        storageBucket: "necotastudio-app.firebasestorage.app",
        messagingSenderId: "1093173509944",
        appId: "1:1093173509944:web:5340935ddffdd49628cbcd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    const vData = { "å®šç•ª": ["ã‚­ãƒ£ãƒ™ãƒ„", "ãƒ¬ã‚¿ã‚¹", "ç™½èœ"], "å’Œé¢¨": ["ã»ã†ã‚Œã‚“è‰", "å°æ¾èœ", "æ˜¥èŠ"], "ãƒãƒ¼ãƒ–": ["ãƒ‘ã‚¯ãƒãƒ¼", "ãƒ«ãƒƒã‚³ãƒ©"] };
    const dData = { "ç”Ÿ": ["ã‚µãƒ©ãƒ€", "ãƒãƒ§ãƒƒãƒ—ãƒ‰"], "åŠ ç†±": ["é‡èœç‚’ã‚", "ãŠæµ¸ã—"], "é£²ã¿ç‰©": ["é’æ±", "ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼"] };
    
    const rarities = {
        C: { label: "Common", color: "var(--rare-c)", price: 20 },
        U: { label: "Uncommon", color: "var(--rare-u)", price: 100 },
        R: { label: "Rare", color: "var(--rare-r)", price: 300 },
        E: { label: "Epic", color: "var(--rare-e)", price: 800 },
        L: { label: "Legend", color: "var(--rare-l)", price: 2500 }
    };

    const bookMaster = [
        { id:1, cat:"æ­´å²", title:"ã‚­ãƒ£ãƒ™ãƒ„ç‹æœã®æ²¡è½", rare:"C", desc:"ã‹ã¤ã¦ä¸–ç•Œã‚’æ”¯é…ã—ãŸçµçƒä¸€æ—ã®ç‰©èªã€‚" },
        { id:2, cat:"ç§‘å­¦", title:"å…‰åˆæˆã®ãƒ‘ãƒ«ã‚¹", rare:"U", desc:"ç·‘è‰²ãŒãªãœç·‘ãªã®ã‹ã‚’è§£ãæ˜ã‹ã™ã€‚" },
        { id:3, cat:"ç‰©èª", title:"é¢¨ã®ãƒ‘ã‚¯ãƒãƒ¼", rare:"R", desc:"é¦™ã‚ŠãŒå¼·ã™ãã¦è¿½æ”¾ã•ã‚ŒãŸå‹‡è€…ã®æ—…ã€‚" },
        { id:4, cat:"å®Ÿç”¨", title:"ç©¶æ¥µã®åƒåˆ‡ã‚Š", rare:"E", desc:"1ãƒŸãƒªä»¥ä¸‹ã®ä¸–ç•Œã‚’ç›®æŒ‡ã™ã€è·äººã®è¨˜éŒ²ã€‚" },
        { id:5, cat:"ç‰©èª", title:"ç¿¡ç¿ ã®å¸æ›¸", rare:"L", desc:"necotastudioæãä¸‹ã‚ã—ã€ä¼èª¬ã®è–å…¸ã€‚" },
        { id:6, cat:"æ­´å²", title:"ç™½èœã®ã‚·ãƒ«ã‚¯ãƒ­ãƒ¼ãƒ‰", rare:"U", desc:"æ±æ´‹ã®é£Ÿå“ã‚’å¤‰ãˆãŸç™½ã„å·¨å¡”ã®æ­´å²ã€‚" },
        { id:7, cat:"ç§‘å­¦", title:"ã‚±ãƒ¼ãƒ«ã®ç´°èƒ", rare:"R", desc:"ç”Ÿå‘½åŠ›ã®å¡Šã‚’é¡•å¾®é¡ã§è¦—ãã€‚" }
    ];

    let myLeaves = 0;
    let myBooks = [];
    let curMode = 'veg';
    let curTab = 'ã™ã¹ã¦';

    // --- ãƒ­ã‚°ã‚¤ãƒ³ & åŒæœŸ ---
    window.login = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('user-display').style.display = 'block';
            document.getElementById('user-display').innerText = `ğŸŒ¿ ${user.displayName} ã•ã‚“`;
            
            const docSnap = await getDoc(doc(db, "leafy_library", user.uid));
            if (docSnap.exists()) {
                myLeaves = docSnap.data().leaves || 0;
                myBooks = docSnap.data().books || [];
            }
            updateUI();
        }
    });

    async function syncCloud() {
        const user = auth.currentUser;
        if (user) {
            await setDoc(doc(db, "leafy_library", user.uid), { leaves: myLeaves, books: myBooks });
        }
    }

    // --- UI ãƒ­ã‚¸ãƒƒã‚¯ ---
    window.switchMode = (m) => {
        curMode = m;
        document.getElementById('m-veg').className = m==='veg' ? 'm-btn active' : 'm-btn';
        document.getElementById('m-dish').className = m==='dish' ? 'm-btn active' : 'm-btn';
        const catS = document.getElementById('cat-select');
        catS.innerHTML = "";
        const target = m==='veg' ? vData : dData;
        Object.keys(target).forEach(c => catS.add(new Option(c, c)));
        updateItemList();
    };

    window.updateItemList = () => {
        const cat = document.getElementById('cat-select').value;
        const itemS = document.getElementById('item-select');
        itemS.innerHTML = "";
        const target = curMode==='veg' ? vData[cat] : dData[cat];
        target.forEach(i => itemS.add(new Option(i, i)));
    };

    window.earnLeaves = async (val) => {
        const item = document.getElementById('item-select').value;
        myLeaves += val;
        updateUI();
        await syncCloud();
        showPanel(`
            <div style="font-size: 3rem;">ğŸƒ</div>
            <h3>åè”µã—ã¾ã—ãŸï¼</h3>
            <p>${item}ã‚’é£Ÿã¹ã¦<br><b style="font-size:1.8rem; color:red;">${val}æš</b> ç²å¾—ã—ã¾ã—ãŸï¼</p>
        `);
    };

    function updateUI() {
        document.getElementById('leaf-total').innerText = myLeaves;
        renderShelf();
        renderStore();
    }

    function renderShelf() {
        const shelf = document.getElementById('my-shelf');
        shelf.innerHTML = "";
        myBooks.forEach(bid => {
            const b = bookMaster.find(x => x.id === bid);
            const r = rarities[b.rare];
            const spine = document.createElement('div');
            spine.className = `book-spine ${b.rare==='L' ? 'glow-l' : ''}`;
            spine.style.backgroundColor = r.color;
            spine.onclick = () => showPanel(`
                <h2 style="color:${r.color}">ã€${b.title}ã€</h2>
                <p style="font-size:0.9rem; color:#666;">ãƒ¬ã‚¢: ${r.label} / åˆ†é¡: ${b.cat}</p>
                <p style="margin:20px 0;">${b.desc}</p>
                <a href="https://hb.afl.rakuten.co.jp/hgc/38bc4499.7d06e22c.38bc449a.2e400495/?pc=https%3A%2F%2Fsearch.rakuten.co.jp%2Fsearch%2Fmall%2F${encodeURIComponent(b.title)}" target="_blank" style="color:red; font-weight:bold; text-decoration:none;">æ¥½å¤©ã§é–¢é€£æœ¬ã‚’æ¢ã™ â”</a>
            `);
            shelf.appendChild(spine);
        });
    }

    function renderStore() {
        const grid = document.getElementById('store-grid');
        grid.innerHTML = "";
        
        // ã‚¿ãƒ–ç”Ÿæˆ
        const tabs = ['ã™ã¹ã¦', ...new Set(bookMaster.map(b => b.cat))];
        const tabArea = document.getElementById('store-tabs');
        if(tabArea.innerHTML === "") {
            tabs.forEach(t => {
                const b = document.createElement('button');
                b.className = `tab-btn ${t===curTab ? 'active' : ''}`;
                b.innerText = t;
                b.onclick = () => { curTab = t; renderStore(); };
                tabArea.appendChild(b);
            });
        }
        Array.from(tabArea.children).forEach(b => b.classList.toggle('active', b.innerText === curTab));

        // å•†å“ç”Ÿæˆ
        bookMaster.filter(b => curTab==='ã™ã¹ã¦' || b.cat===curTab).forEach(b => {
            const r = rarities[b.rare];
            const isBought = myBooks.includes(b.id);
            const canBuy = myLeaves >= r.price;
            grid.innerHTML += `
                <div class="store-item" style="border-color:${isBought?'#eee':r.color}">
                    <span class="rare-tag" style="background:${r.color}">${b.rare}</span>
                    <div style="width:45px; height:65px; background:${r.color}; margin:8px auto; border-radius:4px; box-shadow:2px 4px 8px rgba(0,0,0,0.1);"></div>
                    <div style="font-size:0.75rem; font-weight:900;">${b.title}</div>
                    <div style="font-size:0.9rem; color:red; font-weight:900;">${r.price} æš</div>
                    <button class="buy-btn" onclick="buyBook(${b.id})" 
                        style="background:${canBuy?r.color:'#ccc'}; color:white;"
                        ${isBought||!canBuy?'disabled':''}>${isBought?'æ‰€è”µæ¸ˆã¿':'è³¼å…¥'}</button>
                </div>
            `;
        });
    }

    window.buyBook = async (id) => {
        const b = bookMaster.find(x => x.id === id);
        const price = rarities[b.rare].price;
        if(myLeaves >= price) {
            myLeaves -= price;
            myBooks.push(id);
            updateUI();
            await syncCloud();
            showPanel(`<h3>ğŸ“– è³¼å…¥ã—ã¾ã—ãŸï¼</h3><p>ã€${b.title}ã€ãŒã‚ãªãŸã®æœ¬æ£šã«åŠ ã‚ã‚Šã¾ã—ãŸã€‚</p>`);
        }
    };

    window.showPanel = (html) => {
        document.getElementById('panel-content').innerHTML = html;
        document.getElementById('panel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    };

    window.closePanel = () => {
        document.getElementById('panel').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    };

    switchMode('veg'); // åˆæœŸåŒ–
</script>
</body>
</html>
