<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leafy Library | necotastudio</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary-green: #4CAF50;
            --dark-green: #2E7D32;
            --wood-brown: #5D4037;
            --paper-white: #F5F5DC;
            --rare-c: #9e9e9e; --rare-u: #2196f3; --rare-r: #9c27b0; --rare-e: #ff9800; --rare-l: #d4af37;
        }

        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--paper-white); color: var(--wood-brown); margin: 0; padding-bottom: 50px; display: flex; flex-direction: column; align-items: center; }
        
        header { background: var(--primary-green); color: white; width: 100%; padding: 15px 0; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        /* Êàª„Çã„Éú„Çø„É≥ */
        .back-home { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: white; text-decoration: none; font-size: 0.8rem; border: 1px solid white; padding: 4px 10px; border-radius: 20px; font-weight: bold; background: rgba(0,0,0,0.1); }

        .container { width: 95%; max-width: 500px; margin: 10px 0; box-sizing: border-box; }

        /* „Çπ„ÉÜ„Éº„Çø„Çπ */
        .status-box { background: white; padding: 15px; border-radius: 20px; text-align: center; border: 2px solid #ddd; }
        .leaf-display { font-size: 2rem; font-weight: 900; color: var(--dark-green); margin: 5px 0; }
        .limit-info { font-size: 11px; color: #888; text-align: left; margin-top: 10px; display: flex; justify-content: space-between; }
        .limit-bar-container { background: #eee; height: 8px; border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .limit-bar { background: var(--primary-green); height: 100%; width: 0%; transition: 0.3s; }

        /* Êú¨Ê£ö */
        .bookshelf {
            background-color: var(--wood-brown); padding: 15px; border-radius: 12px; min-height: 80px;
            display: flex; flex-wrap: wrap; gap: 5px; border-bottom: 15px solid #3e2723;
            box-shadow: inset 0 -5px 15px rgba(0,0,0,0.4);
        }
        .book-spine { width: 18px; height: 65px; border-left: 2px solid rgba(255,255,255,0.2); border-radius: 2px; cursor: pointer; transition: 0.2s; position: relative; }
        .book-spine:hover { transform: translateY(-10px); }
        .glow-l { box-shadow: 0 0 12px var(--rare-l); border: 1px solid white; }

        /* ÂÖ•Âäõ„Ç´„Éº„Éâ */
        .input-card { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 3px solid var(--primary-green); }
        .mode-tabs { display: flex; gap: 8px; margin-bottom: 15px; }
        .m-btn { flex: 1; padding: 10px; border: 2px solid var(--primary-green); background: white; border-radius: 12px; cursor: pointer; font-weight: bold; font-family: inherit; }
        .m-btn.active { background: var(--primary-green); color: white; }
        
        select { padding: 12px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; width: 100%; font-family: inherit; margin-bottom: 10px; background: #fff; }
        
        .count-btn-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
        .count-btn { 
            padding: 15px 0; border-radius: 12px; border: 2px solid var(--primary-green); background: white; 
            color: var(--dark-green); font-weight: 900; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 4px 0 var(--primary-green); transition: 0.1s;
        }
        .count-btn:active:not(:disabled) { transform: translateY(3px); box-shadow: none; }
        .count-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #ccc; box-shadow: 0 4px 0 #ccc; }
        .count-btn.special { background: #ff9800; border-color: #e68a00; color: white; box-shadow: 0 4px 0 #cc7a00; }

        .btn-undo { background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: bold; margin-top: 15px; float: right; }
        .btn-undo:disabled { background: #ccc; }

        /* Êú¨Â±ã */
        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .store-item { background: white; border-radius: 15px; padding: 12px; text-align: center; border: 2px solid #eee; position: relative; }
        .rare-tag { position: absolute; top:0; right:0; font-size: 0.6rem; color: white; padding: 2px 6px; border-bottom-left-radius: 10px; }
        .buy-btn { width: 100%; padding: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 8px; }

        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 100; display:none; }
        #panel { position: fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:85%; max-width:400px; background:white; border-radius:30px; padding:30px; z-index: 101; display:none; text-align:center; border: 6px solid var(--primary-green); box-sizing: border-box;}
    </style>
</head>
<body>

<header>
    <a href="https://jyonjyon-code.github.io/hirumeshi/" class="back-home"><i class="fas fa-chevron-left"></i> Êàª„Çã</a>
    <h1 style="margin:0; font-size: 1.5rem;">Leafy Library</h1>
</header>

<div class="container status-box">
    <div id="user-display" style="font-size: 12px; color: #666; margin-bottom: 5px;"></div>
    <div class="leaf-display">üçÉ <span id="leaf-total">0</span> <small style="font-size: 1rem;">Êûö</small></div>
    
    <div class="limit-info">
        <span>‰ªäÊó•„ÅÆÂèéËîµ‰∏äÈôê</span>
        <span><span id="daily-count-txt">0</span> / 50 Êûö</span>
    </div>
    <div class="limit-bar-container">
        <div id="limit-bar" class="limit-bar"></div>
    </div>
    
    <button id="login-btn" class="count-btn" style="width: 100%; font-size: 1rem; padding: 8px; margin-top:15px;" onclick="login()">Google„É≠„Ç∞„Ç§„É≥</button>
    <a href="https://jyonjyon-code.github.io/hirumeshi/" style="display:block; margin-top:10px; font-size:11px; color:#888; text-decoration:none;">necotastudio„Å´Êàª„Çã</a>
</div>

<div class="container">
    <div class="bookshelf" id="my-shelf"></div>
</div>

<div class="container input-card">
    <div class="mode-tabs">
        <button id="m-veg" class="m-btn active" onclick="switchMode('veg')">ü•¨ Ëëâ„Å£„Å±</button>
        <button id="m-dish" class="m-btn" onclick="switchMode('dish')">üç≥ ÊñôÁêÜ</button>
    </div>
    
    <select id="cat-select" onchange="updateItemList()"></select>
    <select id="item-select"></select>

    <div class="count-btn-group">
        <button class="count-btn add-btn" onclick="earnLeaves(1)">+1</button>
        <button class="count-btn add-btn" onclick="earnLeaves(5)">+5</button>
        <button class="count-btn add-btn" onclick="earnLeaves(10)">+10</button>
        <button class="count-btn add-btn special" onclick="earnLeaves(30)">+30</button>
    </div>

    <button id="undo-btn" class="btn-undo" onclick="undoLast()" disabled><i class="fas fa-undo"></i> 1„Å§Êàª„Åô</button>
    <div style="clear:both;"></div>
</div>

<div class="container">
    <h3 style="border-left: 5px solid var(--primary-green); padding-left: 10px;">‰∫§ÊèõÊâÄ (Store)</h3>
    <div class="store-grid" id="store-grid"></div>
</div>

<div class="overlay" id="overlay" onclick="closePanel()"></div>
<div id="panel">
    <div id="panel-content"></div>
    <button class="m-btn" style="margin-top:20px;" onclick="closePanel()">Èñâ„Åò„Çã</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyA7pcr0G4qEx0yLNWueZPdaeQoEBjFuoic", authDomain: "necotastudio-app.firebaseapp.com", projectId: "necotastudio-app", storageBucket: "necotastudio-app.firebasestorage.app", messagingSenderId: "1093173509944", appId: "1:1093173509944:web:5340935ddffdd49628cbcd" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- „É°„Éã„É•„Éº„Éá„Éº„ÇøÂ§ßÂπÖÂ¢óÈáè ---
    const vData = { 
        "ÂÆöÁï™„ÅÆËëâ": ["„Ç≠„É£„Éô„ÉÑ", "„É¨„Çø„Çπ", "ÁôΩËèú", "„Åª„ÅÜ„Çå„ÇìËçâ", "Â∞èÊùæËèú", "„ÉÅ„É≥„Ç≤„É≥Ëèú", "Ê∞¥Ëèú", "„Éñ„É≠„ÉÉ„Ç≥„É™„Éº"],
        "Âíå„ÉªÈ¶ôÂë≥": ["‰∏â„Å§Ëëâ", "Â§ßËëâ", "ËåóËç∑", "„Éã„É©", "Êò•Ëèä", "„Çª„É™", "„ÉØ„Çµ„ÉìËèú", "„Éç„ÇÆ"],
        "Ê¥ã„Éª„Çµ„É©„ÉÄ": ["„Éë„ÇØ„ÉÅ„Éº", "„É´„ÉÉ„Ç≥„É©", "„Ç±„Éº„É´", "„ÇØ„É¨„ÇΩ„É≥", "„Éê„Ç∏„É´", "„Éë„Çª„É™", "„Çª„É≠„É™"],
        "„Çπ„Éó„É©„Ç¶„Éà": ["Ë±ÜËãó", "„Ç´„Ç§„ÉØ„É¨", "„Éñ„É≠„ÉÉ„Ç≥„É™„Éº„Çπ„Éó„É©„Ç¶„Éà", "„Ç¢„É´„Éï„Ç°„É´„Éï„Ç°"]
    };
    const dData = {
        "„Çµ„É©„ÉÄ„ÉªÁîü": ["„Ç∑„Éº„Ç∂„Éº„Çµ„É©„ÉÄ", "„ÉÅ„Éß„ÉÉ„Éó„Éâ„Çµ„É©„ÉÄ", "„Ç≥„Éº„É´„Çπ„É≠„Éº", "ÁîüÊò•Â∑ª„Åç", "„Çµ„É≥„ÉÅ„É•Â∑ª„Åç"],
        "ÁÇí„ÇÅ„ÉªÁÑº„Åç": ["ÈáéËèúÁÇí„ÇÅ", "ÂõûÈçãËÇâ", "Á©∫ËäØËèúÁÇí„ÇÅ", "„Éã„É©Áéâ", "È§ÉÂ≠ê", "ÂÖ´ÂÆùËèú"],
        "ÁÖÆÁâ©„Éª„Çπ„Éº„Éó": ["„É≠„Éº„É´„Ç≠„É£„Éô„ÉÑ", "„Éù„Éà„Éï", "„ÅäÊµ∏„Åó", "Âë≥ÂôåÊ±Å", "„Åª„ÅÜ„Çå„ÇìËçâ„ÅÆËÉ°È∫ªÂíå„Åà"],
        "„Éâ„É™„É≥„ÇØ": ["ÈùíÊ±Å", "„Ç∞„É™„Éº„É≥„Çπ„É†„Éº„Ç∏„Éº", "ÈáéËèú„Ç∏„É•„Éº„Çπ"]
    };

    const rarities = { C: { color: "#9e9e9e", price: 20 }, U: { color: "#2196f3", price: 100 }, R: { color: "#9c27b0", price: 300 }, E: { color: "#ff9800", price: 800 }, L: { color: "#d4af37", price: 2500 } };
    const bookMaster = [
        { id:1, title:"„Ç≠„É£„Éô„ÉÑÁéãÊúù„ÅÆË®òÈå≤", rare:"C", desc:"„Åã„Å§„Å¶È£üÂçì„ÇíÊîØÈÖç„Åó„ÅüÂ∑®Â§ß„Å™Á∑ë„ÅÆÂ∏ùÂõΩ„ÅÆË©±„ÄÇ" },
        { id:2, title:"ÂÖâÂêàÊàê„ÅÆ„Éë„É´„Çπ", rare:"U", desc:"ÂÖâ„ÇíÂäõ„Å´Â§â„Åà„ÇãÈ©öÁï∞„ÅÆ„É°„Ç´„Éã„Ç∫„É†„ÄÇ" },
        { id:3, title:"È¢®„ÅÆ„Éë„ÇØ„ÉÅ„Éº", rare:"R", desc:"È¶ô„Çä„ÅåÂº∑„Åô„Åé„Å¶ÂõΩ„ÇíËøΩ„Çè„Çå„ÅüÂ∞ëÂπ¥„ÅÆÂÜíÈô∫„ÄÇ" },
        { id:4, title:"Á©∂Ê•µ„ÅÆÂçÉÂàá„Çä", rare:"E", desc:"1„Éü„É™„ÅÆÂ£Å„ÇíË∂Ö„Åà„ÅüËÅ∑‰∫∫„ÅåË¶ã„ÅüÊôØËâ≤„ÄÇ" },
        { id:5, title:"Áø°Áø†„ÅÆÂè∏Êõ∏", rare:"L", desc:"necotastudioÊèè„Åç‰∏ã„Çç„Åó„ÄÇÊ£Æ„ÅÆÂÆàË≠∑ËÄÖ„ÅÆÁâ©Ë™û„ÄÇ" },
        { id:6, title:"‰ºùË™¨„ÅÆÈùíÊ±Å‰Ωø„ÅÑ", rare:"L", desc:"ÂÖ®„Å¶„ÅÆËã¶Âë≥„Çí‰πó„ÇäË∂ä„Åà„ÅüËÄÖ„Å´‰∏é„Åà„Çâ„Çå„ÇãÁß∞Âè∑„ÄÇ" }
    ];

    let myLeaves = 0, myBooks = [], lastAdd = 0, dailyCount = 0, todayStr = new Date().toLocaleDateString();

    window.login = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('login-btn').style.display = 'none';
            document.getElementById('user-display').innerText = `üåø ${user.displayName} „Åï„Çì`;
            const docSnap = await getDoc(doc(db, "leafy_library", user.uid));
            if (docSnap.exists()) {
                const d = docSnap.data();
                myLeaves = d.leaves || 0; myBooks = d.books || [];
                dailyCount = (d.lastDate === todayStr) ? (d.dailyCount || 0) : 0;
            }
            updateUI();
        }
    });

    async function sync() {
        const user = auth.currentUser;
        if (user) await setDoc(doc(db, "leafy_library", user.uid), { leaves: myLeaves, books: myBooks, dailyCount: dailyCount, lastDate: todayStr });
    }

    window.earnLeaves = async (val) => {
        if (dailyCount + val > 50) { alert("1Êó•„ÅÆ‰∏äÈôêÔºà50ÊûöÔºâ„ÇíË∂Ö„Åà„Åæ„ÅôÔºÅ"); return; }
        myLeaves += val; dailyCount += val; lastAdd = val;
        document.getElementById('undo-btn').disabled = false;
        updateUI(); await sync();
    };

    window.undoLast = async () => {
        if (lastAdd > 0) {
            myLeaves -= lastAdd; dailyCount -= lastAdd; lastAdd = 0;
            document.getElementById('undo-btn').disabled = true;
            updateUI(); await sync();
        }
    };

    function updateUI() {
        document.getElementById('leaf-total').innerText = myLeaves;
        document.getElementById('daily-count-txt').innerText = dailyCount;
        document.getElementById('limit-bar').style.width = `${(dailyCount/50)*100}%`;
        const btns = document.querySelectorAll('.add-btn');
        btns.forEach(b => b.disabled = dailyCount >= 50);
        renderShelf(); renderStore();
    }

    window.switchMode = (m) => {
        document.getElementById('m-veg').className = m==='veg' ? 'm-btn active' : 'm-btn';
        document.getElementById('m-dish').className = m==='dish' ? 'm-btn active' : 'm-btn';
        const catS = document.getElementById('cat-select'); catS.innerHTML = "";
        const target = m==='veg' ? vData : dData;
        Object.keys(target).forEach(c => catS.add(new Option(c, c)));
        updateItemList();
    };

    window.updateItemList = () => {
        const cat = document.getElementById('cat-select').value;
        const itemS = document.getElementById('item-select'); itemS.innerHTML = "";
        const target = (vData[cat] || dData[cat]);
        target.forEach(i => itemS.add(new Option(i, i)));
    };

    function renderShelf() {
        const shelf = document.getElementById('my-shelf'); shelf.innerHTML = "";
        myBooks.forEach(bid => {
            const b = bookMaster.find(x => x.id === bid);
            if (!b) return;
            const spine = document.createElement('div');
            spine.className = `book-spine ${b.rare==='L' ? 'glow-l' : ''}`;
            spine.style.backgroundColor = rarities[b.rare].color;
            spine.onclick = () => showPanel(`<h2>„Äé${b.title}„Äè</h2><p>${b.desc}</p>`);
            shelf.appendChild(spine);
        });
    }

    function renderStore() {
        const grid = document.getElementById('store-grid'); grid.innerHTML = "";
        bookMaster.forEach(b => {
            const r = rarities[b.rare];
            const isBought = myBooks.includes(b.id);
            const canBuy = myLeaves >= r.price;
            grid.innerHTML += `<div class="store-item" style="border-color:${r.color}">
                <span class="rare-tag" style="background:${r.color}">${b.rare}</span>
                <div style="font-size:0.75rem; font-weight:bold;">${b.title}</div>
                <div style="color:red; font-size:0.8rem; font-weight:bold;">${r.price}Êûö</div>
                <button class="buy-btn" onclick="buyBook(${b.id})" style="background:${canBuy?r.color:'#ccc'}; color:white;" ${isBought||!canBuy?'disabled':''}>${isBought?'ÊâÄËîµÊ∏à':'Ë≥ºÂÖ•'}</button>
            </div>`;
        });
    }

    window.buyBook = async (id) => {
        const b = bookMaster.find(x => x.id === id);
        if(myLeaves >= rarities[b.rare].price) {
            myLeaves -= rarities[b.rare].price; myBooks.push(id);
            updateUI(); await sync();
        }
    };

    window.showPanel = (html) => { document.getElementById('panel-content').innerHTML = html; document.getElementById('panel').style.display = 'block'; document.getElementById('overlay').style.display = 'block'; };
    window.closePanel = () => { document.getElementById('panel').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; };

    switchMode('veg');
</script>
</body>
</html>
